(function(X,u){typeof exports=="object"&&typeof module<"u"?module.exports=u():typeof define=="function"&&define.amd?define(u):(X=typeof globalThis<"u"?globalThis:X||self,X["telegram-bot"]=u())})(this,function(){"use strict";var lo=Object.defineProperty;var ho=(X,u,M)=>u in X?lo(X,u,{enumerable:!0,configurable:!0,writable:!0,value:M}):X[u]=M;var we=(X,u,M)=>(ho(X,typeof u!="symbol"?u+"":u,M),M);function X(r,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const s in n)if(s!=="default"&&!(s in r)){const i=Object.getOwnPropertyDescriptor(n,s);i&&Object.defineProperty(r,s,i.get?i:{enumerable:!0,get:()=>n[s]})}}}return Object.freeze(Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}))}const u={API_KEY:null,CHAT_MODEL:"gpt-3.5-turbo",NOTION_API_KEY:null,NOTION_DATABASE_ID:null,SUPABASE_URL:null,SUPABASE_ANON_KEY:null,SUPABASE_STORAGE_BUCKET:null,STAR_NEXUS_HUB_API:null,TELEGRAM_AVAILABLE_TOKENS:[],TELEGRAM_BOT_NAME:[],I_AM_A_GENEROUS_PERSON:!1,CHAT_WHITE_LIST:[],CHAT_GROUP_WHITE_LIST:[],GROUP_CHAT_BOT_ENABLE:!0,GROUP_CHAT_BOT_SHARE_MODE:!1,AUTO_TRIM_HISTORY:!0,MAX_HISTORY_LENGTH:20,MAX_TOKEN_LENGTH:2048,GPT3_TOKENS_COUNT:!1,SYSTEM_INIT_MESSAGE:"You are a helpful assistant",SYSTEM_INIT_MESSAGE_ROLE:"system",ENABLE_USAGE_STATISTICS:!1,HIDE_COMMAND_BUTTONS:["/role"],UPDATE_BRANCH:"main",BUILD_TIMESTAMP:"1684823847",BUILD_VERSION:"49a1d99",I18N:null,LANGUAGE:"zh-cn",DEBUG_MODE:!1,DEV_MODE:!1,TELEGRAM_API_DOMAIN:"https://api.telegram.org",OPENAI_API_DOMAIN:"https://api.openai.com"},M={PASSWORD_KEY:"chat_history_password",GROUP_TYPES:["group","supergroup"],USER_AGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.2 Safari/605.1.15"};let $=null,De=null;const tr={API_KEY:"string",NOTION_API_KEY:"string",NOTION_DATABASE_ID:"string",STAR_NEXUS_HUB_API:"string"};function rr(r,e){$=r.DATABASE,De=r.API_GUARD;for(const t in u)if(r[t])switch(tr[t]||typeof u[t]){case"number":u[t]=parseInt(r[t])||u[t];break;case"boolean":u[t]=(r[t]||"false")==="true";break;case"string":u[t]=r[t];break;case"object":if(Array.isArray(u[t]))u[t]=r[t].split(",");else try{u[t]=JSON.parse(r[t])}catch(n){console.error(n)}break;default:u[t]=r[t];break}r.TELEGRAM_TOKEN&&!u.TELEGRAM_AVAILABLE_TOKENS.includes(r.TELEGRAM_TOKEN)&&(r.BOT_NAME&&u.TELEGRAM_AVAILABLE_TOKENS.length===u.TELEGRAM_BOT_NAME.length&&u.TELEGRAM_BOT_NAME.push(r.BOT_NAME),u.TELEGRAM_AVAILABLE_TOKENS.push(r.TELEGRAM_TOKEN)),u.I18N=e((u.LANGUAGE||"cn").toLowerCase()),u.SYSTEM_INIT_MESSAGE=u.I18N.env.system_init_message}const nr=/[a-zA-Z0-9_\u0392-\u03C9\u00C0-\u00FF\u0600-\u06FF\u0400-\u04FF]+|[\u4E00-\u9FFF\u3400-\u4DBF\uF900-\uFAFF\u3040-\u309F\uAC00-\uD7AF]+/g;function Le(r){const e=r.match(nr);let t=0;if(!e)return 0;for(let n=0;n<e.length;n++)e[n].charCodeAt(0)>=19968?t+=e[n].length*2:t+=1;return t}function sr(r){r=r.replace(/,+,/g,", ");const e=/<img src="(.+)" \/>/g;r=r.replace(e,"![$1]($1)");const t=/<a href="(.+)">(.+)<\/a>/g;return r=r.replace(t,"[$2]($1)"),r=r.replace(/!\[.+?\]\(.+?\)/g,""),r=r.replace(/<(?:.|\n)*?>/gm,""),r=r.replace(/<\/(?:.|\n)*?>/gm,""),r=r.replace(/#+\s/g,""),r=r.replace(/\s+/g," "),r=r.replace(/\n{2,}/g,`
`),r=r.trim(),r=cr(r),r}function ir(r,e){let t=r;if(r&&Object.keys(e).length)for(const n in e)t=t.replaceAll(`{${n}}`,e[n]);return t}const or={"&amp;":"&","&lt;":"<","&gt;":">","&#60;":"<","&#62;":">","&le;":"≤","&#8804;":"≤","&ge;":"≥","&#8805;":"≥","&quot;":'"',"&#34;":'"',"&trade;":"™","&#8482;":"™","&asymp;":"≈","&#8776;":"≈","&ndash;":"-","&#8211;":"-","&mdash;":"—","&#8212;":"—","&copy;":"©","&#169;":"©","&reg;":"®","&#174;":"®","&ne;":"≠","&#8800;":"≠","&pound;":"£","&#163;":"£","&euro;":"€","&#8364;":"€","&deg;":"°","&#176;":"°","&#39;":"'","&apos;":"'","&nbsp;":" ","&#160;":" "};function ar(r){return r.replace(/(&amp;|&lt;|&#60;|&gt;|&#62;|&le;|&#8804;|&ge;|&#8805;|&quot;|&#34;|&trade;|&#8482;|&asymp;|&#8776;|&ndash;|&#8211;|&mdash;|&#8212;|&copy;|&#169;|&reg;|&#174;|&ne;|&#8800;|&pound;|&#163;|&euro;|&#8364;|&deg;|&#176;|&#39;|&apos;|&nbsp;|&#160;|&quot;|&#34;|&trade;|&#8482;|&asymp;|&#8776;|&ndash;|&#8211;|&mdash;|&#8212;|&copy;|&#169;|&reg;|&#174;|&ne;|&#8800;|&pound;|&#163;|&euro;|&#8364;|&deg;|&#176;|&#39;|&apos;|&nbsp;|&#160;)/g,e=>or[e]||e)}function cr(r){return ar(r)}function pt(r){let e=r.message||"";return r.data&&(e+=JSON.stringify(r.data)),e}class lr{constructor(){we(this,"USER_CONFIG",{SYSTEM_INIT_MESSAGE:u.SYSTEM_INIT_MESSAGE,OPENAI_API_EXTRA_PARAMS:{},OPENAI_API_KEY:null});we(this,"USER_DEFINE",{ROLE:{}});we(this,"CURRENT_CHAT_CONTEXT",{chat_id:null,reply_to_message_id:null,parse_mode:"Markdown"});we(this,"SHARE_CONTEXT",{currentBotId:null,currentBotToken:null,currentBotName:null,chatHistoryKey:null,configStoreKey:null,groupAdminKey:null,usageKey:null,chatType:null,chatId:null,speakerId:null,role:null})}_initChatContext(e,t){this.CURRENT_CHAT_CONTEXT.chat_id=e,this.CURRENT_CHAT_CONTEXT.reply_to_message_id=t,t&&(this.CURRENT_CHAT_CONTEXT.allow_sending_without_reply=!0)}async _initUserConfig(e){try{const t=JSON.parse(await $.get(e));for(const n in t)n==="USER_DEFINE"&&typeof this.USER_DEFINE==typeof t[n]?this._initUserDefine(t[n]):this.USER_CONFIG.hasOwnProperty(n)&&typeof this.USER_CONFIG[n]==typeof t[n]&&(this.USER_CONFIG[n]=t[n])}catch(t){console.error(t)}}_initUserDefine(e){for(const t in e)this.USER_DEFINE.hasOwnProperty(t)&&typeof this.USER_DEFINE[t]==typeof e[t]&&(this.USER_DEFINE[t]=e[t])}initTelegramContext(e){const{pathname:t}=new URL(e.url),n=t.match(/^\/telegram\/(\d+:[A-Za-z0-9_-]{35})\/webhook/)[1],s=u.TELEGRAM_AVAILABLE_TOKENS.indexOf(n);if(s===-1)throw new Error("Token not allowed");this.SHARE_CONTEXT.currentBotToken=n,this.SHARE_CONTEXT.currentBotId=n.split(":")[0],u.TELEGRAM_BOT_NAME.length>s&&(this.SHARE_CONTEXT.currentBotName=u.TELEGRAM_BOT_NAME[s])}async _initShareContext(e){var c,l,a;this.SHARE_CONTEXT.usageKey=`usage:${this.SHARE_CONTEXT.currentBotId}`;const t=(c=e==null?void 0:e.chat)==null?void 0:c.id;if(t==null)throw new Error("Chat id not found");const n=this.SHARE_CONTEXT.currentBotId;let s=`history:${t}`,i=`user_config:${t}`,o=null;n&&(s+=`:${n}`,i+=`:${n}`),M.GROUP_TYPES.includes((l=e.chat)==null?void 0:l.type)&&(!u.GROUP_CHAT_BOT_SHARE_MODE&&e.from.id&&(s+=`:${e.from.id}`,i+=`:${e.from.id}`),o=`group_admin:${t}`),this.SHARE_CONTEXT.chatHistoryKey=s,this.SHARE_CONTEXT.configStoreKey=i,this.SHARE_CONTEXT.groupAdminKey=o,this.SHARE_CONTEXT.chatType=(a=e.chat)==null?void 0:a.type,this.SHARE_CONTEXT.chatId=e.chat.id,this.SHARE_CONTEXT.speakerId=e.from.id||e.chat.id}async initContext(e){var s,i;const t=(s=e==null?void 0:e.chat)==null?void 0:s.id,n=M.GROUP_TYPES.includes((i=e.chat)==null?void 0:i.type)?e.message_id:null;this._initChatContext(t,n),await this._initShareContext(e),await this._initUserConfig(this.SHARE_CONTEXT.configStoreKey)}}async function _t(r,e,t){return await fetch(`${u.TELEGRAM_API_DOMAIN}/bot${e}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,text:r})})}async function hr(r,e,t){const n=t;if(r.length<=4096){const i=await _t(r,e,n);if(i.status===200)return i}const s=4e3;n.parse_mode="HTML";for(let i=0;i<r.length;i+=s){const o=r.slice(i,i+s);await _t(`<pre>
${o}
</pre>`,e,n)}return new Response("Message batch send",{status:200})}function T(r){return async e=>hr(e,r.SHARE_CONTEXT.currentBotToken,r.CURRENT_CHAT_CONTEXT)}async function ur(r,e,t){return await fetch(`${u.TELEGRAM_API_DOMAIN}/bot${e}/sendPhoto`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,photo:r,parse_mode:null})})}function dr(r){return e=>ur(e,r.SHARE_CONTEXT.currentBotToken,r.CURRENT_CHAT_CONTEXT)}async function fr(r,e,t){return await fetch(`${u.TELEGRAM_API_DOMAIN}/bot${e}/sendChatAction`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:t,action:r})}).then(n=>n.json())}function Me(r){return e=>fr(e,r.SHARE_CONTEXT.currentBotToken,r.CURRENT_CHAT_CONTEXT.chat_id)}async function pr(r,e){return await fetch(`${u.TELEGRAM_API_DOMAIN}/bot${r}/setWebhook`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})}).then(t=>t.json())}async function _r(r,e,t,n){let s;try{s=JSON.parse(await $.get(e))}catch(i){return console.error(i),i.message}if(!s||!Array.isArray(s)||s.length===0){const i=await gr(t,n);if(i==null)return null;s=i,await $.put(e,JSON.stringify(s),{expiration:Date.now()/1e3+120})}for(let i=0;i<s.length;i++){const o=s[i];if(o.user.id===r)return o.status}return"member"}function mr(r){return e=>_r(e,r.SHARE_CONTEXT.groupAdminKey,r.CURRENT_CHAT_CONTEXT.chat_id,r.SHARE_CONTEXT.currentBotToken)}async function gr(r,e){try{const t=await fetch(`${u.TELEGRAM_API_DOMAIN}/bot${e}/getChatAdministrators`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:r})}).then(n=>n.json());if(t.ok)return t.result}catch(t){return console.error(t),null}}async function yr(r){const e=await fetch(`${u.TELEGRAM_API_DOMAIN}/bot${r}/getMe`,{method:"POST",headers:{"Content-Type":"application/json"}}).then(t=>t.json());return e.ok?{ok:!0,info:{name:e.result.first_name,bot_name:e.result.username,can_join_groups:e.result.can_join_groups,can_read_all_group_messages:e.result.can_read_all_group_messages}}:e}async function mt(r,e){try{const t=await $.get(r);if(t&&t!=="")return t}catch(t){console.error(t)}try{const t=await fetch(e,{headers:{"User-Agent":M.USER_AGENT}}).then(n=>n.text());return await $.put(r,t),t}catch(t){console.error(t)}return null}async function gt(){const r="https://raw.githubusercontent.com/tbxark-archive/GPT-3-Encoder/master",e=await mt("encoder_raw_file",`${r}/encoder.json`).then(y=>JSON.parse(y)),t=await mt("bpe_raw_file",`${r}/vocab.bpe`),n=(y,w)=>Array.from(Array(w).keys()).slice(y),s=y=>y.charCodeAt(0),i=y=>String.fromCharCode(y),o=new TextEncoder("utf-8"),c=y=>Array.from(o.encode(y)).map(w=>w.toString()),l=(y,w)=>{const P={};return y.forEach((x,A)=>{P[y[A]]=w[A]}),P};function a(){const y=n(s("!"),s("~")+1).concat(n(s("¡"),s("¬")+1),n(s("®"),s("ÿ")+1));let w=y.slice(),P=0;for(let A=0;A<2**8;A++)y.includes(A)||(y.push(A),w.push(2**8+P),P=P+1);w=w.map(A=>i(A));const x={};return y.forEach((A,q)=>{x[y[q]]=w[q]}),x}function h(y){const w=new Set;let P=y[0];for(let x=1;x<y.length;x++){const A=y[x];w.add([P,A]),P=A}return w}const f=/'s|'t|'re|'ve|'m|'ll|'d| ?\p{L}+| ?\p{N}+| ?[^\s\p{L}\p{N}]+|\s+(?!\S)|\s+/gu,p={};Object.keys(e).forEach(y=>{p[e[y]]=y});const g=t.split(`
`),m=g.slice(1,g.length-1).map(y=>y.split(/(\s+)/).filter(w=>w.trim().length>0)),b=a(),v={};Object.keys(b).forEach(y=>{v[b[y]]=y});const C=l(m,n(0,m.length)),k=new Map;function F(y){if(k.has(y))return k.get(y);let w=y.split(""),P=h(w);if(!P)return y;for(;;){const x={};Array.from(P).forEach(J=>{const d=C[J];x[isNaN(d)?1e11:d]=J});const A=x[Math.min(...Object.keys(x).map(J=>parseInt(J)))];if(!(A in C))break;const q=A[0],ne=A[1];let j=[],H=0;for(;H<w.length;){const J=w.indexOf(q,H);if(J===-1){j=j.concat(w.slice(H));break}j=j.concat(w.slice(H,J)),H=J,w[H]===q&&H<w.length-1&&w[H+1]===ne?(j.push(q+ne),H=H+2):(j.push(w[H]),H=H+1)}if(w=j,w.length===1)break;P=h(w)}return w=w.join(" "),k.set(y,w),w}return function(w){let P=0;const x=Array.from(w.matchAll(f)).map(A=>A[0]);for(let A of x){A=c(A).map(ne=>b[ne]).join("");const q=F(A).split(" ").map(ne=>e[ne]);P+=q.length}return P}}function vr(r){const e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";let t="";for(let n=r;n>0;--n)t+=e[Math.floor(Math.random()*e.length)];return t}async function br(){let r=await $.get(M.PASSWORD_KEY);return r===null&&(r=vr(32),await $.put(M.PASSWORD_KEY,r)),r}function pe(r){return`
<html>  
  <head>
    <title>ChatGPT-Telegram-Workers</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="ChatGPT-Telegram-Workers">
    <meta name="author" content="TBXark">
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        text-align: left;
        background-color: #fff;
      }
      h1 {
        margin-top: 0;
        margin-bottom: 0.5rem;
      }
      p {
        margin-top: 0;
        margin-bottom: 1rem;
      }
      a {
        color: #007bff;
        text-decoration: none;
        background-color: transparent;
      }
      a:hover {
        color: #0056b3;
        text-decoration: underline;
      }
      strong {
        font-weight: bolder;
      }
    </style>
  </head>
  <body>
    ${r}
  </body>
</html>
  `}function se(r){return JSON.stringify({message:r.message,stack:r.stack})}function yt(r,e,t){switch(typeof r[e]){case"number":r[e]=Number(t);break;case"boolean":r[e]=t==="true";break;case"string":r[e]=t;break;case"object":const n=JSON.parse(t);if(typeof n=="object"){r[e]=n;break}throw new Error(u.I18N.utils.not_supported_configuration);default:throw new Error(u.I18N.utils.not_supported_configuration)}}async function Er(){let r=e=>Array.from(e).length;try{u.GPT3_TOKENS_COUNT&&(r=await gt())}catch(e){console.error(e)}return e=>{try{return r(e)}catch(t){return console.error(t),Array.from(e).length}}}function vt(r){return r===null?new Response("NOT HANDLED",{status:200}):r.status===200?r:new Response(r.body,{status:200,headers:{"Original-Status":r.status,...r.headers}})}async function Tr(r,e,t){var o;const n=t.USER_CONFIG.OPENAI_API_KEY||u.API_KEY,s={model:u.CHAT_MODEL,...t.USER_CONFIG.OPENAI_API_EXTRA_PARAMS,messages:[...e||[],{role:"user",content:r}]},i=await fetch(`${u.OPENAI_API_DOMAIN}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(s)}).then(c=>c.json());if((o=i.error)!=null&&o.message)throw u.DEV_MODE||u.DEV_MODE?new Error(`OpenAI API Error
> ${i.error.message}
Body: ${JSON.stringify(s)}`):new Error(`OpenAI API Error
> ${i.error.message}`);return setTimeout(()=>Or(i.usage,t).catch(console.error),0),i.choices[0].message.content}async function wr(r,e){var i;const t=e.USER_CONFIG.OPENAI_API_KEY||u.API_KEY,n={prompt:r,n:1,size:"512x512"},s=await fetch(`${u.OPENAI_API_DOMAIN}/v1/images/generations`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(n)}).then(o=>o.json());if((i=s.error)!=null&&i.message)throw new Error(`OpenAI API Error
> ${s.error.message}`);return s.data[0].url}async function Sr(r,e,t){const n=u.AUTO_TRIM_HISTORY&&u.MAX_HISTORY_LENGTH<=0,s=e.SHARE_CONTEXT.chatHistoryKey;let i=await Ar(s,e);if(t){const a=t(i,r);i=a.history,r=a.text}const{real:o,original:c}=i,l=await Tr(r,o,e);return n||(c.push({role:"user",content:r||"",cosplay:e.SHARE_CONTEXT.role||""}),c.push({role:"assistant",content:l,cosplay:e.SHARE_CONTEXT.role||""}),await $.put(s,JSON.stringify(c)).catch(console.error)),l}async function Or(r,e){if(!u.ENABLE_USAGE_STATISTICS)return;let t=JSON.parse(await $.get(e.SHARE_CONTEXT.usageKey));t||(t={tokens:{total:0,chats:{}}}),t.tokens.total+=r.total_tokens,t.tokens.chats[e.SHARE_CONTEXT.chatId]?t.tokens.chats[e.SHARE_CONTEXT.chatId]+=r.total_tokens:t.tokens.chats[e.SHARE_CONTEXT.chatId]=r.total_tokens,await $.put(e.SHARE_CONTEXT.usageKey,JSON.stringify(t))}async function Ar(r,e){const t={role:"system",content:e.USER_CONFIG.SYSTEM_INIT_MESSAGE};if(u.AUTO_TRIM_HISTORY&&u.MAX_HISTORY_LENGTH<=0)return t.role=u.SYSTEM_INIT_MESSAGE_ROLE,{real:[t],original:[t]};let s=[];try{s=JSON.parse(await $.get(r))}catch(l){console.error(l)}(!s||!Array.isArray(s))&&(s=[]);let i=JSON.parse(JSON.stringify(s));e.SHARE_CONTEXT.role&&(s=s.filter(l=>e.SHARE_CONTEXT.role===l.cosplay)),s.forEach(l=>{delete l.cosplay});const o=await Er(),c=(l,a,h,f)=>{l.length>h&&(l=l.splice(l.length-h));let p=a;for(let g=l.length-1;g>=0;g--){const m=l[g];let b=0;if(m.content?b=o(m.content):m.content="",p+=b,p>f){l=l.splice(g+1);break}}return l};if(u.AUTO_TRIM_HISTORY&&u.MAX_HISTORY_LENGTH>0){const l=o(t.content),a=Math.max(Object.keys(e.USER_DEFINE.ROLE).length,1);s=c(s,l,u.MAX_HISTORY_LENGTH,u.MAX_TOKEN_LENGTH),i=c(i,l,u.MAX_HISTORY_LENGTH*a,u.MAX_TOKEN_LENGTH*a)}switch(s.length>0?s[0].role:""){case"assistant":case"system":s[0]=t;break;default:s.unshift(t)}return u.SYSTEM_INIT_MESSAGE_ROLE!=="system"&&s.length>0&&s[0].role==="system"&&(s[0].role=u.SYSTEM_INIT_MESSAGE_ROLE),{real:s,original:i}}const z={default(r){return M.GROUP_TYPES.includes(r)?["administrator","creator"]:!1},shareModeGroup(r){return M.GROUP_TYPES.includes(r)&&u.GROUP_CHAT_BOT_SHARE_MODE?["administrator","creator"]:!1}},Q={"/help":{scopes:["all_private_chats","all_chat_administrators"],fn:Nr},"/new":{scopes:["all_private_chats","all_group_chats","all_chat_administrators"],fn:bt,needAuth:z.shareModeGroup},"/start":{scopes:["all_private_chats","all_chat_administrators"],fn:bt,needAuth:z.default},"/img":{scopes:["all_private_chats","all_chat_administrators"],fn:Cr,needAuth:z.shareModeGroup},"/version":{scopes:["all_private_chats","all_chat_administrators"],fn:Pr,needAuth:z.default},"/setenv":{scopes:[],fn:Ir,needAuth:z.shareModeGroup},"/delenv":{scopes:[],fn:$r,needAuth:z.shareModeGroup},"/usage":{scopes:["all_private_chats","all_chat_administrators"],fn:kr,needAuth:z.default},"/system":{scopes:["all_private_chats","all_chat_administrators"],fn:jr,needAuth:z.default},"/role":{scopes:["all_private_chats"],fn:Rr,needAuth:z.shareModeGroup},"/redo":{scopes:["all_private_chats","all_group_chats","all_chat_administrators"],fn:Ur,needAuth:z.shareModeGroup}};async function Rr(r,e,t,n){if(t==="show"){const h=Object.getOwnPropertyNames(n.USER_DEFINE.ROLE).length;if(h===0)return T(n)(u.I18N.command.role.not_defined_any_role);let f=u.I18N.command.role.current_defined_role(h);for(const p in n.USER_DEFINE.ROLE)n.USER_DEFINE.ROLE.hasOwnProperty(p)&&(f+=`~${p}:
<pre>`,f+=`${JSON.stringify(n.USER_DEFINE.ROLE[p])}
`,f+="</pre>");return n.CURRENT_CHAT_CONTEXT.parse_mode="HTML",T(n)(f)}const s=t.indexOf(" ");if(s===-1)return T(n)(u.I18N.command.role.help);const i=t.slice(0,s),o=t.slice(s+1).trim(),c=o.indexOf("=");if(c===-1){if(o==="del")try{if(n.USER_DEFINE.ROLE[i])return delete n.USER_DEFINE.ROLE[i],await $.put(n.SHARE_CONTEXT.configStoreKey,JSON.stringify(Object.assign(n.USER_CONFIG,{USER_DEFINE:n.USER_DEFINE}))),T(n)(u.I18N.command.role.delete_role_success)}catch(h){return T(n)(u.I18N.command.role.delete_role_error(h))}return T(n)(u.I18N.command.role.help)}const l=o.slice(0,c),a=o.slice(c+1);n.USER_DEFINE.ROLE[i]||(n.USER_DEFINE.ROLE[i]={SYSTEM_INIT_MESSAGE:u.SYSTEM_INIT_MESSAGE,OPENAI_API_EXTRA_PARAMS:{}});try{return yt(n.USER_DEFINE.ROLE[i],l,a),await $.put(n.SHARE_CONTEXT.configStoreKey,JSON.stringify(Object.assign(n.USER_CONFIG,{USER_DEFINE:n.USER_DEFINE}))),T(n)(u.I18N.command.role.update_role_success)}catch(h){return T(n)(u.I18N.command.role.update_role_error(h))}}async function Cr(r,e,t,n){if(t==="")return T(n)(u.I18N.command.img.help);try{setTimeout(()=>Me(n)("upload_photo").catch(console.error),0);const s=await wr(t,n);try{return dr(n)(s)}catch{return T(n)(`${s}`)}}catch(s){return T(n)(`ERROR: ${s.message}`)}}async function Nr(r,e,t,n){const s=u.I18N.command.help.summary+Object.keys(Q).map(i=>`${i}：${u.I18N.command.help[i.substring(1)]}`).join(`
`);return T(n)(s)}async function bt(r,e,t,n){try{return await $.delete(n.SHARE_CONTEXT.chatHistoryKey),e==="/new"?T(n)(u.I18N.command.new.new_chat_start):n.SHARE_CONTEXT.chatType==="private"?T(n)(u.I18N.command.new.new_chat_start_private(n.CURRENT_CHAT_CONTEXT.chat_id)):T(n)(u.I18N.command.new.new_chat_start_group(n.CURRENT_CHAT_CONTEXT.chat_id))}catch(s){return T(n)(`ERROR: ${s.message}`)}}async function Ir(r,e,t,n){const s=t.indexOf("=");if(s===-1)return T(n)(u.I18N.command.setenv.help);const i=t.slice(0,s),o=t.slice(s+1);try{return yt(n.USER_CONFIG,i,o),await $.put(n.SHARE_CONTEXT.configStoreKey,JSON.stringify(n.USER_CONFIG)),T(n)(u.I18N.command.setenv.update_config_success)}catch(c){return T(n)(u.I18N.command.setenv.update_config_error(c))}}async function $r(r,e,t,n){try{return n.USER_CONFIG[t]=null,await $.put(n.SHARE_CONTEXT.configStoreKey,JSON.stringify(n.USER_CONFIG)),T(n)(u.I18N.command.setenv.update_config_success)}catch(s){return T(n)(u.I18N.command.setenv.update_config_error(s))}}async function Pr(r,e,t,n){const s={headers:{"User-Agent":M.USER_AGENT}},i={ts:u.BUILD_TIMESTAMP,sha:u.BUILD_VERSION},o=`https://raw.githubusercontent.com/LarchLiu/star-nexus/${u.UPDATE_BRANCH}`,c=`${o}/dist/timestamp`,l=`${o}/dist/buildinfo.json`;let a=await fetch(l,s).then(h=>h.json()).catch(()=>null);if(a||(a=await fetch(c,s).then(h=>h.text()).then(h=>({ts:Number(h.trim()),sha:"unknown"})).catch(()=>({ts:0,sha:"unknown"}))),i.ts<a.ts){const h=u.I18N.command.version.new_version_found(i,a);return T(n)(h)}else{const h=u.I18N.command.version.current_is_latest_version(i);return T(n)(h)}}async function kr(r,e,t,n){if(!u.ENABLE_USAGE_STATISTICS)return T(n)(u.I18N.command.usage.usage_not_open);const s=JSON.parse(await $.get(n.SHARE_CONTEXT.usageKey));let i=u.I18N.command.usage.current_usage;if(s!=null&&s.tokens){const{tokens:o}=s,c=Object.keys(o.chats||{}).sort((l,a)=>o.chats[a]-o.chats[l]);i+=u.I18N.command.usage.total_usage(o.total);for(let l=0;l<Math.min(c.length,30);l++)i+=`
  - ${c[l]}: ${o.chats[c[l]]} tokens`;c.length===0?i+="0 tokens":c.length>30&&(i+=`
  ...`)}else i+=u.I18N.command.usage.no_usage;return T(n)(i)}async function jr(r,e,t,n){let s=`Current System Info:
`;if(s+=`OpenAI Model:${u.CHAT_MODEL}
`,u.DEV_MODE){const i={...n.SHARE_CONTEXT};i.currentBotToken="******",n.USER_CONFIG.OPENAI_API_KEY="******",s+="<pre>",s+=`USER_CONFIG: 
${JSON.stringify(n.USER_CONFIG,null,2)}
`,s+=`CHAT_CONTEXT: 
${JSON.stringify(n.CURRENT_CHAT_CONTEXT,null,2)}
`,s+=`SHARE_CONTEXT: 
${JSON.stringify(i,null,2)}
`,s+="</pre>"}return n.CURRENT_CHAT_CONTEXT.parse_mode="HTML",T(n)(s)}async function Ur(r,e,t,n){setTimeout(()=>Me(n)("typing").catch(console.error),0);const s=await Sr(t,n,(i,o)=>{const{real:c,original:l}=i;let a=o;for(;;){const h=c.pop();if(l.pop(),h==null)break;if(h.role==="user"){(o===""||o===void 0||o===null)&&(a=h.content);break}}return{history:{real:c,original:l},text:a}});return T(n)(s)}async function Dr(r,e,t,n){let s="<pre>";return s+=JSON.stringify({message:r},null,2),s+="</pre>",n.CURRENT_CHAT_CONTEXT.parse_mode="HTML",T(n)(s)}async function Lr(r,e){u.DEV_MODE&&(Q["/echo"]={help:"[DEBUG ONLY] echo message",scopes:["all_private_chats","all_chat_administrators"],fn:Dr,needAuth:z.default});for(const t in Q)if(r.text===t||r.text.startsWith(`${t} `)){const n=Q[t];try{if(n.needAuth){const i=n.needAuth(e.SHARE_CONTEXT.chatType);if(i){const o=await mr(e)(e.SHARE_CONTEXT.speakerId);if(o===null)return T(e)(u.I18N.command.permission.not_authorized);if(!i.includes(o)){const c=u.I18N.command.permission.not_enough_permission(i,o);return T(e)(c)}}}}catch(i){return T(e)(u.I18N.command.permission.role_error(i))}const s=r.text.substring(t.length).trim();try{return await n.fn(r,t,s,e)}catch(i){return T(e)(u.I18N.command.permission.command_error(i))}}return null}async function Mr(r){const e={all_private_chats:[],all_group_chats:[],all_chat_administrators:[]};for(const n in Q)if(!u.HIDE_COMMAND_BUTTONS.includes(n)&&Q.hasOwnProperty(n)&&Q[n].scopes)for(const s of Q[n].scopes)e[s]||(e[s]=[]),e[s].push(n);const t={};for(const n in e)t[n]=await fetch(`https://api.telegram.org/bot${r}/setMyCommands`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({commands:e[n].map(s=>({command:s,description:u.I18N.command.help[s.substring(1)]||""})),scope:{type:n}})}).then(s=>s.json());return{ok:!0,result:t}}function xr(){return Object.keys(Q).map(r=>({command:r,description:u.I18N.command.help[r.substring(1)]}))}const Hr=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,Br=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,Fr=/^\s*["[{]|^\s*-?\d[\d.]{0,14}\s*$/;function Gr(r,e){if(r!=="__proto__"&&!(r==="constructor"&&e&&typeof e=="object"&&"prototype"in e))return e}function Kr(r,e={}){if(typeof r!="string")return r;const t=r.toLowerCase().trim();if(t==="true")return!0;if(t==="false")return!1;if(t==="null")return null;if(t==="nan")return Number.NaN;if(t==="infinity")return Number.POSITIVE_INFINITY;if(t!=="undefined"){if(!Fr.test(r)){if(e.strict)throw new SyntaxError("Invalid JSON");return r}try{return Hr.test(r)||Br.test(r)?JSON.parse(r,Gr):JSON.parse(r)}catch(n){if(e.strict)throw n;return r}}}const Jr=/#/g,Xr=/&/g,zr=/=/g,Et=/\+/g,Yr=/%5e/gi,Wr=/%60/gi,Vr=/%7c/gi,qr=/%20/gi;function Qr(r){return encodeURI(""+r).replace(Vr,"|")}function xe(r){return Qr(typeof r=="string"?r:JSON.stringify(r)).replace(Et,"%2B").replace(qr,"+").replace(Jr,"%23").replace(Xr,"%26").replace(Wr,"`").replace(Yr,"^")}function He(r){return xe(r).replace(zr,"%3D")}function Tt(r=""){try{return decodeURIComponent(""+r)}catch{return""+r}}function Zr(r){return Tt(r.replace(Et," "))}function en(r=""){const e={};r[0]==="?"&&(r=r.slice(1));for(const t of r.split("&")){const n=t.match(/([^=]+)=?(.*)/)||[];if(n.length<2)continue;const s=Tt(n[1]);if(s==="__proto__"||s==="constructor")continue;const i=Zr(n[2]||"");typeof e[s]<"u"?Array.isArray(e[s])?e[s].push(i):e[s]=[e[s],i]:e[s]=i}return e}function tn(r,e){return(typeof e=="number"||typeof e=="boolean")&&(e=String(e)),e?Array.isArray(e)?e.map(t=>`${He(r)}=${xe(t)}`).join("&"):`${He(r)}=${xe(e)}`:He(r)}function rn(r){return Object.keys(r).filter(e=>r[e]!==void 0).map(e=>tn(e,r[e])).join("&")}const nn=/^\w{2,}:([/\\]{1,2})/,sn=/^\w{2,}:([/\\]{2})?/,on=/^([/\\]\s*){2,}[^/\\]/;function wt(r,e={}){return typeof e=="boolean"&&(e={acceptRelative:e}),e.strict?nn.test(r):sn.test(r)||(e.acceptRelative?on.test(r):!1)}const an=/\/$|\/\?/;function Be(r="",e=!1){return e?an.test(r):r.endsWith("/")}function cn(r="",e=!1){if(!e)return(Be(r)?r.slice(0,-1):r)||"/";if(!Be(r,!0))return r||"/";const[t,...n]=r.split("?");return(t.slice(0,-1)||"/")+(n.length>0?`?${n.join("?")}`:"")}function ln(r="",e=!1){if(!e)return r.endsWith("/")?r:r+"/";if(Be(r,!0))return r||"/";const[t,...n]=r.split("?");return t+"/"+(n.length>0?`?${n.join("?")}`:"")}function hn(r=""){return r.startsWith("/")}function un(r=""){return(hn(r)?r.slice(1):r)||"/"}function dn(r,e){if(pn(e)||wt(r))return r;const t=cn(e);return r.startsWith(t)?r:mn(t,r)}function fn(r,e){const t=St(r),n={...en(t.search),...e};return t.search=rn(n),gn(t)}function pn(r){return!r||r==="/"}function _n(r){return r&&r!=="/"}function mn(r,...e){let t=r||"";for(const n of e.filter(s=>_n(s)))t=t?ln(t)+un(n):n;return t}function St(r="",e){if(!wt(r,{acceptRelative:!0}))return e?St(e+r):Ot(r);const[t="",n,s=""]=(r.replace(/\\/g,"/").match(/([^/:]+:)?\/\/([^/@]+@)?(.*)/)||[]).splice(1),[i="",o=""]=(s.match(/([^#/?]*)(.*)?/)||[]).splice(1),{pathname:c,search:l,hash:a}=Ot(o.replace(/\/(?=[A-Za-z]:)/,""));return{protocol:t,auth:n?n.slice(0,Math.max(0,n.length-1)):"",host:i,pathname:c,search:l,hash:a}}function Ot(r=""){const[e="",t="",n=""]=(r.match(/([^#?]*)(\?[^#]*)?(#.*)?/)||[]).splice(1);return{pathname:e,search:t,hash:n}}function gn(r){const e=r.pathname+(r.search?(r.search.startsWith("?")?"":"?")+r.search:"")+r.hash;return r.protocol?r.protocol+"//"+(r.auth?r.auth+"@":"")+r.host+e:e}class yn extends Error{constructor(){super(...arguments),this.name="FetchError"}}function vn(r,e,t){let n="";e&&(n=e.message),r&&t?n=`${n} (${t.status} ${t.statusText} (${r.toString()}))`:r&&(n=`${n} (${r.toString()})`);const s=new yn(n);return Object.defineProperty(s,"request",{get(){return r}}),Object.defineProperty(s,"response",{get(){return t}}),Object.defineProperty(s,"data",{get(){return t&&t._data}}),Object.defineProperty(s,"status",{get(){return t&&t.status}}),Object.defineProperty(s,"statusText",{get(){return t&&t.statusText}}),Object.defineProperty(s,"statusCode",{get(){return t&&t.status}}),Object.defineProperty(s,"statusMessage",{get(){return t&&t.statusText}}),s}const bn=new Set(Object.freeze(["PATCH","POST","PUT","DELETE"]));function At(r="GET"){return bn.has(r.toUpperCase())}function En(r){if(r===void 0)return!1;const e=typeof r;return e==="string"||e==="number"||e==="boolean"||e===null?!0:e!=="object"?!1:Array.isArray(r)?!0:r.constructor&&r.constructor.name==="Object"||typeof r.toJSON=="function"}const Tn=new Set(["image/svg","application/xml","application/xhtml","application/html"]),wn=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function Sn(r=""){if(!r)return"json";const e=r.split(";").shift()||"";return wn.test(e)?"json":Tn.has(e)||e.startsWith("text/")?"text":"blob"}const On=new Set([408,409,425,429,500,502,503,504]);function Rt(r){const{fetch:e,Headers:t}=r;function n(o){const c=o.error&&o.error.name==="AbortError"||!1;if(o.options.retry!==!1&&!c){let a;typeof o.options.retry=="number"?a=o.options.retry:a=At(o.options.method)?0:1;const h=o.response&&o.response.status||500;if(a>0&&On.has(h))return s(o.request,{...o.options,retry:a-1})}const l=vn(o.request,o.error,o.response);throw Error.captureStackTrace&&Error.captureStackTrace(l,s),l}const s=async function(c,l={}){const a={request:c,options:{...r.defaults,...l},response:void 0,error:void 0};a.options.onRequest&&await a.options.onRequest(a),typeof a.request=="string"&&(a.options.baseURL&&(a.request=dn(a.request,a.options.baseURL)),(a.options.query||a.options.params)&&(a.request=fn(a.request,{...a.options.params,...a.options.query})),a.options.body&&At(a.options.method)&&En(a.options.body)&&(a.options.body=typeof a.options.body=="string"?a.options.body:JSON.stringify(a.options.body),a.options.headers=new t(a.options.headers),a.options.headers.has("content-type")||a.options.headers.set("content-type","application/json"),a.options.headers.has("accept")||a.options.headers.set("accept","application/json"))),a.response=await e(a.request,a.options).catch(async f=>(a.error=f,a.options.onRequestError&&await a.options.onRequestError(a),n(a)));const h=(a.options.parseResponse?"json":a.options.responseType)||Sn(a.response.headers.get("content-type")||"");if(h==="json"){const f=await a.response.text(),p=a.options.parseResponse||Kr;a.response._data=p(f)}else h==="stream"?a.response._data=a.response.body:a.response._data=await a.response[h]();return a.options.onResponse&&await a.options.onResponse(a),a.response.status>=400&&a.response.status<600?(a.options.onResponseError&&await a.options.onResponseError(a),n(a)):a.response},i=function(c,l){return s(c,l).then(a=>a._data)};return i.raw=s,i.native=e,i.create=(o={})=>Rt({...r,defaults:{...r.defaults,...o}}),i}const Ct=function(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")}(),An=Ct.fetch||(()=>Promise.reject(new Error("[ofetch] global.fetch is not supported!"))),Rn=Ct.Headers,W=Rt({fetch:An,Headers:Rn}),Cn="github.com",Nn="twitter.com",he={}.VITE_NOTION_API_URL||"https://api.notion.com/v1",In={}.VITE_OPENAI_API_HOST||"https://api.openai.com/v1",$n=`Please summarize content within 300 words and then classify it to 1-5 types of classification. Classification names should be short and no explanation or description is needed.
You only speak JSON. Do not write text that isn't JSON. The JSON keys must be English word of "summary" and "categories".
Classification names used with array data.
The JSON format must be:
{
  "summary": "This is the summary content."
  "categories": ["XXX","YYY","ZZZ"]
}
`,Pn=`Please answer in {language}. The Content is {webprompts}:
=====
{content}
=====
Please answer in {language}.`,kn={de:"German",en:"English",es:"Spanish",fr:"Franch",kr:"Korean",nl:"Dutch",it:"Italian",ja:"Japanese",pt:"Portuguese",ru:"Russian","zh-CN":"Chinese"};var jn=Object.defineProperty,Un=(r,e,t)=>e in r?jn(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Se=(r,e,t)=>(Un(r,typeof e!="symbol"?e+"":e,t),t);let Dn=class{constructor(e,t){Se(this,"config"),Se(this,"data"),this.config=e,this.data=t}},Ln=class{constructor(e,t){Se(this,"config"),Se(this,"data"),this.config=e,this.data=t}},Mn=class extends Dn{constructor(e,t){super(e,t)}async create(e){if(!e&&!this.data)throw new Error("DataStorage error: No Storage Data");const t=e||this.data,n={title:t.title,summary:t.summary,url:t.url,categories:t.categories,status:"Starred",meta:t.meta};return await xn(this.config,n)}async updateOgImage(e,t){return await Hn(this.config,e.storageId,t)}getConfig(){return this.config}getType(){return{type:"DataStorage",name:"NotionDataStorage"}}};async function xn(r,e){const t=r.apiKey;let n=[{name:"Others"}];n=e.categories.map(a=>(a=a.trim(),a.endsWith(".")&&(a=a.slice(0,-1)),{name:a}));const s={parent:{database_id:r.databaseId},properties:{Title:{title:[{text:{content:e.title}}]},Summary:{rich_text:[{text:{content:e.summary}}]},URL:{url:e.url},Categories:{multi_select:n},Status:{select:{name:"Starred"}}}};let i=r.defaultOgImage;if(e.meta&&Object.keys(e.meta).length>0){const a=e.meta;if(a.ogImage&&(i=a.ogImage),s.properties={...s.properties,OgImage:{url:i}},s.properties={...s.properties,Website:{select:{name:a.siteName}}},e.meta.domain===Cn){const h=a;if(h.languages){const f=h.languages.map(p=>({name:p}));s.properties={...s.properties,Languages:{multi_select:f}}}if(h.tags){const f=h.tags.map(p=>({name:p}));s.properties={...s.properties,Tags:{multi_select:f}}}}else if(e.meta.domain===Nn){const h=a;if(h.tags){const f=h.tags.map(p=>({name:p}));s.properties={...s.properties,Tags:{multi_select:f}}}}}const o=await W(`${he}/databases/${r.databaseId}/query`,{method:"POST",headers:{"Content-Type":"application/json","Notion-Version":"2022-06-28",Authorization:`Bearer ${t}`},body:{filter:{property:"URL",rich_text:{contains:e.url}}}});let c="",l=!1;if(o.results.length>0&&(o.results[0].properties.Status.select.name==="Starred"&&(l=!0),c=o.results[0].id),c)return s.properties={...s.properties,Status:{select:{name:l?"Unstarred":"Starred"}}},await W(`${he}/pages/${c}`,{method:"PATCH",headers:{Authorization:`Bearer ${t}`,"Notion-Version":"2022-06-28","Content-Type":"application/json"},body:s}),{starred:!l,storageId:c};if(i){const a={object:"block",image:{external:{url:i}}};s.children=[a]}return c=(await W(`${he}/pages`,{method:"POST",headers:{"Content-Type":"application/json","Notion-Version":"2022-06-28",Authorization:`Bearer ${t}`},body:s})).id,{starred:!l,storageId:c}}async function Hn(r,e,t){const n=await W(`${he}/blocks/${e}/children`,{method:"GET",headers:{"Content-Type":"application/json","Notion-Version":"2022-06-28",Authorization:`Bearer ${r.apiKey}`}});let s="";if(n.results.length>0){const i=n.results,o=i.length;for(let c=0;c<o;c++)if(i[c].type==="image"&&i[c].image.type==="external"&&i[c].image.external.url.includes("starnexusogimage")){s=i[c].id;break}}return await W(`${he}/pages/${e}`,{method:"PATCH",headers:{Authorization:`Bearer ${r.apiKey}`,"Notion-Version":"2022-06-28","Content-Type":"application/json"},body:{properties:{OgImage:{url:t}}}}),s&&await W(`${he}/blocks/${s}`,{method:"PATCH",headers:{Authorization:`Bearer ${r.apiKey}`,"Notion-Version":"2022-06-28","Content-Type":"application/json"},body:{image:{external:{url:t}}}}),{url:t}}var Bn=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})};const Fn=r=>{let e;return r?e=r:typeof fetch>"u"?e=(...t)=>Bn(void 0,void 0,void 0,function*(){return yield(yield Promise.resolve().then(()=>Oe)).fetch(...t)}):e=fetch,(...t)=>e(...t)};class Fe extends Error{constructor(e,t="FunctionsError",n){super(e),super.name=t,this.context=n}}class Gn extends Fe{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class Kn extends Fe{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class Jn extends Fe{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var Xn=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})};class zn{constructor(e,{headers:t={},customFetch:n}={}){this.url=e,this.headers=t,this.fetch=Fn(n)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var n;return Xn(this,void 0,void 0,function*(){try{const{headers:s,method:i,body:o}=t;let c={},l;o&&(s&&!Object.prototype.hasOwnProperty.call(s,"Content-Type")||!s)&&(typeof Blob<"u"&&o instanceof Blob||o instanceof ArrayBuffer?(c["Content-Type"]="application/octet-stream",l=o):typeof o=="string"?(c["Content-Type"]="text/plain",l=o):typeof FormData<"u"&&o instanceof FormData?l=o:(c["Content-Type"]="application/json",l=JSON.stringify(o)));const a=yield this.fetch(`${this.url}/${e}`,{method:i||"POST",headers:Object.assign(Object.assign(Object.assign({},c),this.headers),s),body:l}).catch(g=>{throw new Gn(g)}),h=a.headers.get("x-relay-error");if(h&&h==="true")throw new Kn(a);if(!a.ok)throw new Jn(a);let f=((n=a.headers.get("Content-Type"))!==null&&n!==void 0?n:"text/plain").split(";")[0].trim(),p;return f==="application/json"?p=yield a.json():f==="application/octet-stream"?p=yield a.blob():f==="multipart/form-data"?p=yield a.formData():p=yield a.text(),{data:p,error:null}}catch(s){return{data:null,error:s}}})}}var Yn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Wn(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Ge={exports:{}};(function(r,e){var t=typeof self<"u"?self:Yn,n=function(){function i(){this.fetch=!1,this.DOMException=t.DOMException}return i.prototype=t,new i}();(function(i){(function(o){var c={searchParams:"URLSearchParams"in i,iterable:"Symbol"in i&&"iterator"in Symbol,blob:"FileReader"in i&&"Blob"in i&&function(){try{return new Blob,!0}catch{return!1}}(),formData:"FormData"in i,arrayBuffer:"ArrayBuffer"in i};function l(d){return d&&DataView.prototype.isPrototypeOf(d)}if(c.arrayBuffer)var a=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],h=ArrayBuffer.isView||function(d){return d&&a.indexOf(Object.prototype.toString.call(d))>-1};function f(d){if(typeof d!="string"&&(d=String(d)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(d))throw new TypeError("Invalid character in header field name");return d.toLowerCase()}function p(d){return typeof d!="string"&&(d=String(d)),d}function g(d){var _={next:function(){var S=d.shift();return{done:S===void 0,value:S}}};return c.iterable&&(_[Symbol.iterator]=function(){return _}),_}function m(d){this.map={},d instanceof m?d.forEach(function(_,S){this.append(S,_)},this):Array.isArray(d)?d.forEach(function(_){this.append(_[0],_[1])},this):d&&Object.getOwnPropertyNames(d).forEach(function(_){this.append(_,d[_])},this)}m.prototype.append=function(d,_){d=f(d),_=p(_);var S=this.map[d];this.map[d]=S?S+", "+_:_},m.prototype.delete=function(d){delete this.map[f(d)]},m.prototype.get=function(d){return d=f(d),this.has(d)?this.map[d]:null},m.prototype.has=function(d){return this.map.hasOwnProperty(f(d))},m.prototype.set=function(d,_){this.map[f(d)]=p(_)},m.prototype.forEach=function(d,_){for(var S in this.map)this.map.hasOwnProperty(S)&&d.call(_,this.map[S],S,this)},m.prototype.keys=function(){var d=[];return this.forEach(function(_,S){d.push(S)}),g(d)},m.prototype.values=function(){var d=[];return this.forEach(function(_){d.push(_)}),g(d)},m.prototype.entries=function(){var d=[];return this.forEach(function(_,S){d.push([S,_])}),g(d)},c.iterable&&(m.prototype[Symbol.iterator]=m.prototype.entries);function b(d){if(d.bodyUsed)return Promise.reject(new TypeError("Already read"));d.bodyUsed=!0}function v(d){return new Promise(function(_,S){d.onload=function(){_(d.result)},d.onerror=function(){S(d.error)}})}function C(d){var _=new FileReader,S=v(_);return _.readAsArrayBuffer(d),S}function k(d){var _=new FileReader,S=v(_);return _.readAsText(d),S}function F(d){for(var _=new Uint8Array(d),S=new Array(_.length),L=0;L<_.length;L++)S[L]=String.fromCharCode(_[L]);return S.join("")}function y(d){if(d.slice)return d.slice(0);var _=new Uint8Array(d.byteLength);return _.set(new Uint8Array(d)),_.buffer}function w(){return this.bodyUsed=!1,this._initBody=function(d){this._bodyInit=d,d?typeof d=="string"?this._bodyText=d:c.blob&&Blob.prototype.isPrototypeOf(d)?this._bodyBlob=d:c.formData&&FormData.prototype.isPrototypeOf(d)?this._bodyFormData=d:c.searchParams&&URLSearchParams.prototype.isPrototypeOf(d)?this._bodyText=d.toString():c.arrayBuffer&&c.blob&&l(d)?(this._bodyArrayBuffer=y(d.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):c.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(d)||h(d))?this._bodyArrayBuffer=y(d):this._bodyText=d=Object.prototype.toString.call(d):this._bodyText="",this.headers.get("content-type")||(typeof d=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):c.searchParams&&URLSearchParams.prototype.isPrototypeOf(d)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},c.blob&&(this.blob=function(){var d=b(this);if(d)return d;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?b(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(C)}),this.text=function(){var d=b(this);if(d)return d;if(this._bodyBlob)return k(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(F(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},c.formData&&(this.formData=function(){return this.text().then(q)}),this.json=function(){return this.text().then(JSON.parse)},this}var P=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function x(d){var _=d.toUpperCase();return P.indexOf(_)>-1?_:d}function A(d,_){_=_||{};var S=_.body;if(d instanceof A){if(d.bodyUsed)throw new TypeError("Already read");this.url=d.url,this.credentials=d.credentials,_.headers||(this.headers=new m(d.headers)),this.method=d.method,this.mode=d.mode,this.signal=d.signal,!S&&d._bodyInit!=null&&(S=d._bodyInit,d.bodyUsed=!0)}else this.url=String(d);if(this.credentials=_.credentials||this.credentials||"same-origin",(_.headers||!this.headers)&&(this.headers=new m(_.headers)),this.method=x(_.method||this.method||"GET"),this.mode=_.mode||this.mode||null,this.signal=_.signal||this.signal,this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&S)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(S)}A.prototype.clone=function(){return new A(this,{body:this._bodyInit})};function q(d){var _=new FormData;return d.trim().split("&").forEach(function(S){if(S){var L=S.split("="),U=L.shift().replace(/\+/g," "),N=L.join("=").replace(/\+/g," ");_.append(decodeURIComponent(U),decodeURIComponent(N))}}),_}function ne(d){var _=new m,S=d.replace(/\r?\n[\t ]+/g," ");return S.split(/\r?\n/).forEach(function(L){var U=L.split(":"),N=U.shift().trim();if(N){var Ue=U.join(":").trim();_.append(N,Ue)}}),_}w.call(A.prototype);function j(d,_){_||(_={}),this.type="default",this.status=_.status===void 0?200:_.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in _?_.statusText:"OK",this.headers=new m(_.headers),this.url=_.url||"",this._initBody(d)}w.call(j.prototype),j.prototype.clone=function(){return new j(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new m(this.headers),url:this.url})},j.error=function(){var d=new j(null,{status:0,statusText:""});return d.type="error",d};var H=[301,302,303,307,308];j.redirect=function(d,_){if(H.indexOf(_)===-1)throw new RangeError("Invalid status code");return new j(null,{status:_,headers:{location:d}})},o.DOMException=i.DOMException;try{new o.DOMException}catch{o.DOMException=function(_,S){this.message=_,this.name=S;var L=Error(_);this.stack=L.stack},o.DOMException.prototype=Object.create(Error.prototype),o.DOMException.prototype.constructor=o.DOMException}function J(d,_){return new Promise(function(S,L){var U=new A(d,_);if(U.signal&&U.signal.aborted)return L(new o.DOMException("Aborted","AbortError"));var N=new XMLHttpRequest;function Ue(){N.abort()}N.onload=function(){var Te={status:N.status,statusText:N.statusText,headers:ne(N.getAllResponseHeaders()||"")};Te.url="responseURL"in N?N.responseURL:Te.headers.get("X-Request-URL");var ft="response"in N?N.response:N.responseText;S(new j(ft,Te))},N.onerror=function(){L(new TypeError("Network request failed"))},N.ontimeout=function(){L(new TypeError("Network request failed"))},N.onabort=function(){L(new o.DOMException("Aborted","AbortError"))},N.open(U.method,U.url,!0),U.credentials==="include"?N.withCredentials=!0:U.credentials==="omit"&&(N.withCredentials=!1),"responseType"in N&&c.blob&&(N.responseType="blob"),U.headers.forEach(function(Te,ft){N.setRequestHeader(ft,Te)}),U.signal&&(U.signal.addEventListener("abort",Ue),N.onreadystatechange=function(){N.readyState===4&&U.signal.removeEventListener("abort",Ue)}),N.send(typeof U._bodyInit>"u"?null:U._bodyInit)})}return J.polyfill=!0,i.fetch||(i.fetch=J,i.Headers=m,i.Request=A,i.Response=j),o.Headers=m,o.Request=A,o.Response=j,o.fetch=J,Object.defineProperty(o,"__esModule",{value:!0}),o})({})})(n),n.fetch.ponyfill=!0,delete n.fetch.polyfill;var s=n;e=s.fetch,e.default=s.fetch,e.fetch=s.fetch,e.Headers=s.Headers,e.Request=s.Request,e.Response=s.Response,r.exports=e})(Ge,Ge.exports);var Ke=Ge.exports;const Je=Wn(Ke),Oe=X({__proto__:null,default:Je},[Ke]);class Vn{constructor(e){this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=e.headers,this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=e.shouldThrowOnError,this.signal=e.signal,this.isMaybeSingle=e.isMaybeSingle,e.fetch?this.fetch=e.fetch:typeof fetch>"u"?this.fetch=Je:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}then(e,t){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),this.method!=="GET"&&this.method!=="HEAD"&&(this.headers["Content-Type"]="application/json");const n=this.fetch;let s=n(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async i=>{var o,c,l;let a=null,h=null,f=null,p=i.status,g=i.statusText;if(i.ok){if(this.method!=="HEAD"){const C=await i.text();C===""||(this.headers.Accept==="text/csv"||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?h=C:h=JSON.parse(C))}const b=(o=this.headers.Prefer)===null||o===void 0?void 0:o.match(/count=(exact|planned|estimated)/),v=(c=i.headers.get("content-range"))===null||c===void 0?void 0:c.split("/");b&&v&&v.length>1&&(f=parseInt(v[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(h)&&(h.length>1?(a={code:"PGRST116",details:`Results contain ${h.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},h=null,f=null,p=406,g="Not Acceptable"):h.length===1?h=h[0]:h=null)}else{const b=await i.text();try{a=JSON.parse(b),Array.isArray(a)&&i.status===404&&(h=[],a=null,p=200,g="OK")}catch{i.status===404&&b===""?(p=204,g="No Content"):a={message:b}}if(a&&this.isMaybeSingle&&(!((l=a==null?void 0:a.details)===null||l===void 0)&&l.includes("Results contain 0 rows"))&&(a=null,p=200,g="OK"),a&&this.shouldThrowOnError)throw a}return{error:a,data:h,count:f,status:p,statusText:g}});return this.shouldThrowOnError||(s=s.catch(i=>{var o,c,l;return{error:{message:`${(o=i==null?void 0:i.name)!==null&&o!==void 0?o:"FetchError"}: ${i==null?void 0:i.message}`,details:`${(c=i==null?void 0:i.stack)!==null&&c!==void 0?c:""}`,hint:"",code:`${(l=i==null?void 0:i.code)!==null&&l!==void 0?l:""}`},data:null,count:null,status:0,statusText:""}})),s.then(e,t)}}class qn extends Vn{select(e){let t=!1;const n=(e??"*").split("").map(s=>/\s/.test(s)&&!t?"":(s==='"'&&(t=!t),s)).join("");return this.url.searchParams.set("select",n),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(e,{ascending:t=!0,nullsFirst:n,foreignTable:s}={}){const i=s?`${s}.order`:"order",o=this.url.searchParams.get(i);return this.url.searchParams.set(i,`${o?`${o},`:""}${e}.${t?"asc":"desc"}${n===void 0?"":n?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t}={}){const n=typeof t>"u"?"limit":`${t}.limit`;return this.url.searchParams.set(n,`${e}`),this}range(e,t,{foreignTable:n}={}){const s=typeof n>"u"?"offset":`${n}.offset`,i=typeof n>"u"?"limit":`${n}.limit`;return this.url.searchParams.set(s,`${e}`),this.url.searchParams.set(i,`${t-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return this.method==="GET"?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:e=!1,verbose:t=!1,settings:n=!1,buffers:s=!1,wal:i=!1,format:o="text"}={}){const c=[e?"analyze":null,t?"verbose":null,n?"settings":null,s?"buffers":null,i?"wal":null].filter(Boolean).join("|"),l=this.headers.Accept;return this.headers.Accept=`application/vnd.pgrst.plan+${o}; for="${l}"; options=${c};`,o==="json"?this:this}rollback(){var e;return((e=this.headers.Prefer)!==null&&e!==void 0?e:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}}class ue extends qn{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}in(e,t){const n=t.map(s=>typeof s=="string"&&new RegExp("[,()]").test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(e,`in.(${n})`),this}contains(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return typeof t=="string"?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:n,type:s}={}){let i="";s==="plain"?i="pl":s==="phrase"?i="ph":s==="websearch"&&(i="w");const o=n===void 0?"":`(${n})`;return this.url.searchParams.append(e,`${i}fts${o}.${t}`),this}match(e){return Object.entries(e).forEach(([t,n])=>{this.url.searchParams.append(t,`eq.${n}`)}),this}not(e,t,n){return this.url.searchParams.append(e,`not.${t}.${n}`),this}or(e,{foreignTable:t}={}){const n=t?`${t}.or`:"or";return this.url.searchParams.append(n,`(${e})`),this}filter(e,t,n){return this.url.searchParams.append(e,`${t}.${n}`),this}}class Qn{constructor(e,{headers:t={},schema:n,fetch:s}){this.url=e,this.headers=t,this.schema=n,this.fetch=s}select(e,{head:t=!1,count:n}={}){const s=t?"HEAD":"GET";let i=!1;const o=(e??"*").split("").map(c=>/\s/.test(c)&&!i?"":(c==='"'&&(i=!i),c)).join("");return this.url.searchParams.set("select",o),n&&(this.headers.Prefer=`count=${n}`),new ue({method:s,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(e,{count:t,defaultToNull:n=!0}={}){const s="POST",i=[];if(this.headers.Prefer&&i.push(this.headers.Prefer),t&&i.push(`count=${t}`),n||i.push("missing=default"),this.headers.Prefer=i.join(","),Array.isArray(e)){const o=e.reduce((c,l)=>c.concat(Object.keys(l)),[]);if(o.length>0){const c=[...new Set(o)].map(l=>`"${l}"`);this.url.searchParams.set("columns",c.join(","))}}return new ue({method:s,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}upsert(e,{onConflict:t,ignoreDuplicates:n=!1,count:s,defaultToNull:i=!0}={}){const o="POST",c=[`resolution=${n?"ignore":"merge"}-duplicates`];if(t!==void 0&&this.url.searchParams.set("on_conflict",t),this.headers.Prefer&&c.push(this.headers.Prefer),s&&c.push(`count=${s}`),i||c.push("missing=default"),this.headers.Prefer=c.join(","),Array.isArray(e)){const l=e.reduce((a,h)=>a.concat(Object.keys(h)),[]);if(l.length>0){const a=[...new Set(l)].map(h=>`"${h}"`);this.url.searchParams.set("columns",a.join(","))}}return new ue({method:o,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}update(e,{count:t}={}){const n="PATCH",s=[];return this.headers.Prefer&&s.push(this.headers.Prefer),t&&s.push(`count=${t}`),this.headers.Prefer=s.join(","),new ue({method:n,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}delete({count:e}={}){const t="DELETE",n=[];return e&&n.push(`count=${e}`),this.headers.Prefer&&n.unshift(this.headers.Prefer),this.headers.Prefer=n.join(","),new ue({method:t,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}}const Zn={"X-Client-Info":"postgrest-js/1.6.1"};class es{constructor(e,{headers:t={},schema:n,fetch:s}={}){this.url=e,this.headers=Object.assign(Object.assign({},Zn),t),this.schema=n,this.fetch=s}from(e){const t=new URL(`${this.url}/${e}`);return new Qn(t,{headers:Object.assign({},this.headers),schema:this.schema,fetch:this.fetch})}rpc(e,t={},{head:n=!1,count:s}={}){let i;const o=new URL(`${this.url}/rpc/${e}`);let c;n?(i="HEAD",Object.entries(t).forEach(([a,h])=>{o.searchParams.append(a,`${h}`)})):(i="POST",c=t);const l=Object.assign({},this.headers);return s&&(l.Prefer=`count=${s}`),new ue({method:i,url:o,headers:l,schema:this.schema,body:c,fetch:this.fetch,allowEmpty:!1})}}var Xe,Nt;function ts(){if(Nt)return Xe;Nt=1;var r=function(){if(typeof self=="object"&&self)return self;if(typeof window=="object"&&window)return window;throw new Error("Unable to resolve global `this`")};return Xe=function(){if(this)return this;if(typeof globalThis=="object"&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:!0})}catch{return r()}try{return __global__||r()}finally{delete Object.prototype.__global__}}(),Xe}var rs={name:"websocket",description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],author:"Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",contributors:["Iñaki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],version:"1.0.34",repository:{type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},homepage:"https://github.com/theturtle32/WebSocket-Node",engines:{node:">=4.0.0"},dependencies:{bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.50","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},devDependencies:{"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},config:{verbose:!1},scripts:{test:"tape test/unit/*.js",gulp:"gulp"},main:"index",directories:{lib:"./lib"},browser:"lib/browser.js",license:"Apache-2.0"}.version,ie;if(typeof globalThis=="object")ie=globalThis;else try{ie=ts()}catch{}finally{if(!ie&&typeof window<"u"&&(ie=window),!ie)throw new Error("Could not determine global this")}var _e=ie.WebSocket||ie.MozWebSocket,ns=rs;function It(r,e){var t;return e?t=new _e(r,e):t=new _e(r),t}_e&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(r){Object.defineProperty(It,r,{get:function(){return _e[r]}})});var ss={w3cwebsocket:_e?It:null,version:ns};const is={"X-Client-Info":"realtime-js/2.7.2"},os="1.0.0",$t=1e4,as=1e3;var me;(function(r){r[r.connecting=0]="connecting",r[r.open=1]="open",r[r.closing=2]="closing",r[r.closed=3]="closed"})(me||(me={}));var G;(function(r){r.closed="closed",r.errored="errored",r.joined="joined",r.joining="joining",r.leaving="leaving"})(G||(G={}));var Y;(function(r){r.close="phx_close",r.error="phx_error",r.join="phx_join",r.reply="phx_reply",r.leave="phx_leave",r.access_token="access_token"})(Y||(Y={}));var ze;(function(r){r.websocket="websocket"})(ze||(ze={}));var oe;(function(r){r.Connecting="connecting",r.Open="open",r.Closing="closing",r.Closed="closed"})(oe||(oe={}));class Pt{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}class cs{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),n=new TextDecoder;return this._decodeBroadcast(e,t,n)}_decodeBroadcast(e,t,n){const s=t.getUint8(1),i=t.getUint8(2);let o=this.HEADER_LENGTH+2;const c=n.decode(e.slice(o,o+s));o=o+s;const l=n.decode(e.slice(o,o+i));o=o+i;const a=JSON.parse(n.decode(e.slice(o,e.byteLength)));return{ref:null,topic:c,event:l,payload:a}}}class Ye{constructor(e,t,n={},s=$t){this.channel=e,this.event=t,this.payload=n,this.timeout=s,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null,this.rateLimited=!1}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){if(this._hasReceived("timeout"))return;this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()})==="rate limited"&&(this.rateLimited=!0)}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var n;return this._hasReceived(e)&&t((n=this.receivedResp)===null||n===void 0?void 0:n.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(n=>n.status===e).forEach(n=>n.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var kt;(function(r){r.SYNC="sync",r.JOIN="join",r.LEAVE="leave"})(kt||(kt={}));class ge{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const n=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(n.state,{},s=>{const{onJoin:i,onLeave:o,onSync:c}=this.caller;this.joinRef=this.channel._joinRef(),this.state=ge.syncState(this.state,s,i,o),this.pendingDiffs.forEach(l=>{this.state=ge.syncDiff(this.state,l,i,o)}),this.pendingDiffs=[],c()}),this.channel._on(n.diff,{},s=>{const{onJoin:i,onLeave:o,onSync:c}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(s):(this.state=ge.syncDiff(this.state,s,i,o),c())}),this.onJoin((s,i,o)=>{this.channel._trigger("presence",{event:"join",key:s,currentPresences:i,newPresences:o})}),this.onLeave((s,i,o)=>{this.channel._trigger("presence",{event:"leave",key:s,currentPresences:i,leftPresences:o})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,n,s){const i=this.cloneDeep(e),o=this.transformState(t),c={},l={};return this.map(i,(a,h)=>{o[a]||(l[a]=h)}),this.map(o,(a,h)=>{const f=i[a];if(f){const p=h.map(v=>v.presence_ref),g=f.map(v=>v.presence_ref),m=h.filter(v=>g.indexOf(v.presence_ref)<0),b=f.filter(v=>p.indexOf(v.presence_ref)<0);m.length>0&&(c[a]=m),b.length>0&&(l[a]=b)}else c[a]=h}),this.syncDiff(i,{joins:c,leaves:l},n,s)}static syncDiff(e,t,n,s){const{joins:i,leaves:o}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return n||(n=()=>{}),s||(s=()=>{}),this.map(i,(c,l)=>{var a;const h=(a=e[c])!==null&&a!==void 0?a:[];if(e[c]=this.cloneDeep(l),h.length>0){const f=e[c].map(g=>g.presence_ref),p=h.filter(g=>f.indexOf(g.presence_ref)<0);e[c].unshift(...p)}n(c,h,l)}),this.map(o,(c,l)=>{let a=e[c];if(!a)return;const h=l.map(f=>f.presence_ref);a=a.filter(f=>h.indexOf(f.presence_ref)<0),e[c]=a,s(c,a,l),a.length===0&&delete e[c]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(n=>t(n,e[n]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,n)=>{const s=e[n];return"metas"in s?t[n]=s.metas.map(i=>(i.presence_ref=i.phx_ref,delete i.phx_ref,delete i.phx_ref_prev,i)):t[n]=s,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var I;(function(r){r.abstime="abstime",r.bool="bool",r.date="date",r.daterange="daterange",r.float4="float4",r.float8="float8",r.int2="int2",r.int4="int4",r.int4range="int4range",r.int8="int8",r.int8range="int8range",r.json="json",r.jsonb="jsonb",r.money="money",r.numeric="numeric",r.oid="oid",r.reltime="reltime",r.text="text",r.time="time",r.timestamp="timestamp",r.timestamptz="timestamptz",r.timetz="timetz",r.tsrange="tsrange",r.tstzrange="tstzrange"})(I||(I={}));const jt=(r,e,t={})=>{var n;const s=(n=t.skipTypes)!==null&&n!==void 0?n:[];return Object.keys(e).reduce((i,o)=>(i[o]=ls(o,r,e,s),i),{})},ls=(r,e,t,n)=>{const s=e.find(c=>c.name===r),i=s==null?void 0:s.type,o=t[r];return i&&!n.includes(i)?Ut(i,o):We(o)},Ut=(r,e)=>{if(r.charAt(0)==="_"){const t=r.slice(1,r.length);return fs(e,t)}switch(r){case I.bool:return hs(e);case I.float4:case I.float8:case I.int2:case I.int4:case I.int8:case I.numeric:case I.oid:return us(e);case I.json:case I.jsonb:return ds(e);case I.timestamp:return ps(e);case I.abstime:case I.date:case I.daterange:case I.int4range:case I.int8range:case I.money:case I.reltime:case I.text:case I.time:case I.timestamptz:case I.timetz:case I.tsrange:case I.tstzrange:return We(e);default:return We(e)}},We=r=>r,hs=r=>{switch(r){case"t":return!0;case"f":return!1;default:return r}},us=r=>{if(typeof r=="string"){const e=parseFloat(r);if(!Number.isNaN(e))return e}return r},ds=r=>{if(typeof r=="string")try{return JSON.parse(r)}catch(e){return console.log(`JSON parse error: ${e}`),r}return r},fs=(r,e)=>{if(typeof r!="string")return r;const t=r.length-1,n=r[t];if(r[0]==="{"&&n==="}"){let i;const o=r.slice(1,t);try{i=JSON.parse("["+o+"]")}catch{i=o?o.split(","):[]}return i.map(c=>Ut(e,c))}return r},ps=r=>typeof r=="string"?r.replace(" ","T"):r;var Dt=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})},Lt;(function(r){r.ALL="*",r.INSERT="INSERT",r.UPDATE="UPDATE",r.DELETE="DELETE"})(Lt||(Lt={}));var Mt;(function(r){r.BROADCAST="broadcast",r.PRESENCE="presence",r.POSTGRES_CHANGES="postgres_changes"})(Mt||(Mt={}));var xt;(function(r){r.SUBSCRIBED="SUBSCRIBED",r.TIMED_OUT="TIMED_OUT",r.CLOSED="CLOSED",r.CHANNEL_ERROR="CHANNEL_ERROR"})(xt||(xt={}));class Ve{constructor(e,t={config:{}},n){this.topic=e,this.params=t,this.socket=n,this.bindings={},this.state=G.closed,this.joinedOnce=!1,this.pushBuffer=[],this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""}},t.config),this.timeout=this.socket.timeout,this.joinPush=new Ye(this,Y.join,this.params,this.timeout),this.rejoinTimer=new Pt(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=G.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(s=>s.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=G.closed,this.socket._remove(this)}),this._onError(s=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,s),this.state=G.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=G.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Y.reply,{},(s,i)=>{this._trigger(this._replyEventName(i),s)}),this.presence=new ge(this)}subscribe(e,t=this.timeout){var n,s;if(this.joinedOnce)throw"tried to subscribe multiple times. 'subscribe' can only be called a single time per channel instance";{const{config:{broadcast:i,presence:o}}=this.params;this._onError(a=>e&&e("CHANNEL_ERROR",a)),this._onClose(()=>e&&e("CLOSED"));const c={},l={broadcast:i,presence:o,postgres_changes:(s=(n=this.bindings.postgres_changes)===null||n===void 0?void 0:n.map(a=>a.filter))!==null&&s!==void 0?s:[]};this.socket.accessToken&&(c.access_token=this.socket.accessToken),this.updateJoinPayload(Object.assign({config:l},c)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",({postgres_changes:a})=>{var h;if(this.socket.accessToken&&this.socket.setAuth(this.socket.accessToken),a===void 0){e&&e("SUBSCRIBED");return}else{const f=this.bindings.postgres_changes,p=(h=f==null?void 0:f.length)!==null&&h!==void 0?h:0,g=[];for(let m=0;m<p;m++){const b=f[m],{filter:{event:v,schema:C,table:k,filter:F}}=b,y=a&&a[m];if(y&&y.event===v&&y.schema===C&&y.table===k&&y.filter===F)g.push(Object.assign(Object.assign({},b),{id:y.id}));else{this.unsubscribe(),e&&e("CHANNEL_ERROR",new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=g,e&&e("SUBSCRIBED");return}}).receive("error",a=>{e&&e("CHANNEL_ERROR",new Error(JSON.stringify(Object.values(a).join(", ")||"error")))}).receive("timeout",()=>{e&&e("TIMED_OUT")})}return this}presenceState(){return this.presence.state}track(e,t={}){return Dt(this,void 0,void 0,function*(){return yield this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)})}untrack(e={}){return Dt(this,void 0,void 0,function*(){return yield this.send({type:"presence",event:"untrack"},e)})}on(e,t,n){return this._on(e,t,n)}send(e,t={}){return new Promise(n=>{var s,i,o;const c=this._push(e.type,e,t.timeout||this.timeout);c.rateLimited&&n("rate limited"),e.type==="broadcast"&&!(!((o=(i=(s=this.params)===null||s===void 0?void 0:s.config)===null||i===void 0?void 0:i.broadcast)===null||o===void 0)&&o.ack)&&n("ok"),c.receive("ok",()=>n("ok")),c.receive("timeout",()=>n("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=G.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Y.close,"leave",this._joinRef())};return this.rejoinTimer.reset(),this.joinPush.destroy(),new Promise(n=>{const s=new Ye(this,Y.leave,{},e);s.receive("ok",()=>{t(),n("ok")}).receive("timeout",()=>{t(),n("timed out")}).receive("error",()=>{n("error")}),s.send(),this._canPush()||s.trigger("ok",{})})}_push(e,t,n=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let s=new Ye(this,e,t,n);return this._canPush()?s.send():(s.startTimeout(),this.pushBuffer.push(s)),s}_onMessage(e,t,n){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,n){var s,i;const o=e.toLocaleLowerCase(),{close:c,error:l,leave:a,join:h}=Y;if(n&&[c,l,a,h].indexOf(o)>=0&&n!==this._joinRef())return;let p=this._onMessage(o,t,n);if(t&&!p)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(o)?(s=this.bindings.postgres_changes)===null||s===void 0||s.filter(g=>{var m,b,v;return((m=g.filter)===null||m===void 0?void 0:m.event)==="*"||((v=(b=g.filter)===null||b===void 0?void 0:b.event)===null||v===void 0?void 0:v.toLocaleLowerCase())===o}).map(g=>g.callback(p,n)):(i=this.bindings[o])===null||i===void 0||i.filter(g=>{var m,b,v,C,k,F;if(["broadcast","presence","postgres_changes"].includes(o))if("id"in g){const y=g.id,w=(m=g.filter)===null||m===void 0?void 0:m.event;return y&&((b=t.ids)===null||b===void 0?void 0:b.includes(y))&&(w==="*"||(w==null?void 0:w.toLocaleLowerCase())===((v=t.data)===null||v===void 0?void 0:v.type.toLocaleLowerCase()))}else{const y=(k=(C=g==null?void 0:g.filter)===null||C===void 0?void 0:C.event)===null||k===void 0?void 0:k.toLocaleLowerCase();return y==="*"||y===((F=t==null?void 0:t.event)===null||F===void 0?void 0:F.toLocaleLowerCase())}else return g.type.toLocaleLowerCase()===o}).map(g=>{if(typeof p=="object"&&"ids"in p){const m=p.data,{schema:b,table:v,commit_timestamp:C,type:k,errors:F}=m;p=Object.assign(Object.assign({},{schema:b,table:v,commit_timestamp:C,eventType:k,new:{},old:{},errors:F}),this._getPayloadRecords(m))}g.callback(p,n)})}_isClosed(){return this.state===G.closed}_isJoined(){return this.state===G.joined}_isJoining(){return this.state===G.joining}_isLeaving(){return this.state===G.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,n){const s=e.toLocaleLowerCase(),i={type:s,filter:t,callback:n};return this.bindings[s]?this.bindings[s].push(i):this.bindings[s]=[i],this}_off(e,t){const n=e.toLocaleLowerCase();return this.bindings[n]=this.bindings[n].filter(s=>{var i;return!(((i=s.type)===null||i===void 0?void 0:i.toLocaleLowerCase())===n&&Ve.isEqual(s.filter,t))}),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(Y.close,{},e)}_onError(e){this._on(Y.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=G.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=jt(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=jt(e.columns,e.old_record)),t}}var qe=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})};const _s=()=>{};class ms{constructor(e,t){var n;this.accessToken=null,this.channels=[],this.endPoint="",this.headers=is,this.params={},this.timeout=$t,this.transport=ss.w3cwebsocket,this.heartbeatIntervalMs=3e4,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.ref=0,this.logger=_s,this.conn=null,this.sendBuffer=[],this.serializer=new cs,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.eventsPerSecondLimitMs=100,this.inThrottle=!1,this.endPoint=`${e}/${ze.websocket}`,t!=null&&t.params&&(this.params=t.params),t!=null&&t.headers&&(this.headers=Object.assign(Object.assign({},this.headers),t.headers)),t!=null&&t.timeout&&(this.timeout=t.timeout),t!=null&&t.logger&&(this.logger=t.logger),t!=null&&t.transport&&(this.transport=t.transport),t!=null&&t.heartbeatIntervalMs&&(this.heartbeatIntervalMs=t.heartbeatIntervalMs);const s=(n=t==null?void 0:t.params)===null||n===void 0?void 0:n.eventsPerSecond;s&&(this.eventsPerSecondLimitMs=Math.floor(1e3/s)),this.reconnectAfterMs=t!=null&&t.reconnectAfterMs?t.reconnectAfterMs:i=>[1e3,2e3,5e3,1e4][i-1]||1e4,this.encode=t!=null&&t.encode?t.encode:(i,o)=>o(JSON.stringify(i)),this.decode=t!=null&&t.decode?t.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new Pt(()=>qe(this,void 0,void 0,function*(){this.disconnect(),this.connect()}),this.reconnectAfterMs)}connect(){this.conn||(this.conn=new this.transport(this._endPointURL(),[],null,this.headers),this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e)))}disconnect(e,t){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,t??""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset())}getChannels(){return this.channels}removeChannel(e){return qe(this,void 0,void 0,function*(){const t=yield e.unsubscribe();return this.channels.length===0&&this.disconnect(),t})}removeAllChannels(){return qe(this,void 0,void 0,function*(){const e=yield Promise.all(this.channels.map(t=>t.unsubscribe()));return this.disconnect(),e})}log(e,t,n){this.logger(e,t,n)}connectionState(){switch(this.conn&&this.conn.readyState){case me.connecting:return oe.Connecting;case me.open:return oe.Open;case me.closing:return oe.Closing;default:return oe.Closed}}isConnected(){return this.connectionState()===oe.Open}channel(e,t={config:{}}){this.isConnected()||this.connect();const n=new Ve(`realtime:${e}`,t,this);return this.channels.push(n),n}push(e){const{topic:t,event:n,payload:s,ref:i}=e;let o=()=>{this.encode(e,c=>{var l;(l=this.conn)===null||l===void 0||l.send(c)})};if(this.log("push",`${t} ${n} (${i})`,s),this.isConnected())if(["broadcast","presence","postgres_changes"].includes(n)){if(this._throttle(o)())return"rate limited"}else o();else this.sendBuffer.push(o)}setAuth(e){this.accessToken=e,this.channels.forEach(t=>{e&&t.updateJoinPayload({access_token:e}),t.joinedOnce&&t._isJoined()&&t._push(Y.access_token,{access_token:e})})}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(n=>n.topic===e&&(n._isJoined()||n._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t._joinRef()!==e._joinRef())}_endPointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:os}))}_onConnMessage(e){this.decode(e.data,t=>{let{topic:n,event:s,payload:i,ref:o}=t;(o&&o===this.pendingHeartbeatRef||s===(i==null?void 0:i.type))&&(this.pendingHeartbeatRef=null),this.log("receive",`${i.status||""} ${n} ${s} ${o&&"("+o+")"||""}`,i),this.channels.filter(c=>c._isMember(n)).forEach(c=>c._trigger(s,i,o)),this.stateChangeCallbacks.message.forEach(c=>c(t))})}_onConnOpen(){this.log("transport",`connected to ${this._endPointURL()}`),this._flushSendBuffer(),this.reconnectTimer.reset(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this._sendHeartbeat(),this.heartbeatIntervalMs),this.stateChangeCallbacks.open.forEach(e=>e())}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(t=>t(e))}_onConnError(e){this.log("transport",e.message),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(t=>t(e))}_triggerChanError(){this.channels.forEach(e=>e._trigger(Y.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const n=e.match(/\?/)?"&":"?",s=new URLSearchParams(t);return`${e}${n}${s}`}_flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_sendHeartbeat(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),(e=this.conn)===null||e===void 0||e.close(as,"hearbeat timeout");return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.setAuth(this.accessToken)}}_throttle(e,t=this.eventsPerSecondLimitMs){return()=>this.inThrottle?!0:(e(),t>0&&(this.inThrottle=!0,setTimeout(()=>{this.inThrottle=!1},t)),!1)}}class Qe extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function D(r){return typeof r=="object"&&r!==null&&"__isStorageError"in r}class gs extends Qe{constructor(e,t){super(e),this.name="StorageApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class Ht extends Qe{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var Bt=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})};const Ft=r=>{let e;return r?e=r:typeof fetch>"u"?e=(...t)=>Bt(void 0,void 0,void 0,function*(){return yield(yield Promise.resolve().then(()=>Oe)).fetch(...t)}):e=fetch,(...t)=>e(...t)},ys=()=>Bt(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield Promise.resolve().then(()=>Oe)).Response:Response});var de=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})};const Ze=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),vs=(r,e)=>de(void 0,void 0,void 0,function*(){const t=yield ys();r instanceof t?r.json().then(n=>{e(new gs(Ze(n),r.status||500))}).catch(n=>{e(new Ht(Ze(n),n))}):e(new Ht(Ze(r),r))}),bs=(r,e,t,n)=>{const s={method:r,headers:(e==null?void 0:e.headers)||{}};return r==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),s.body=JSON.stringify(n),Object.assign(Object.assign({},s),t))};function Ae(r,e,t,n,s,i){return de(this,void 0,void 0,function*(){return new Promise((o,c)=>{r(t,bs(e,n,s,i)).then(l=>{if(!l.ok)throw l;return n!=null&&n.noResolveJson?l:l.json()}).then(l=>o(l)).catch(l=>vs(l,c))})})}function et(r,e,t,n){return de(this,void 0,void 0,function*(){return Ae(r,"GET",e,t,n)})}function ee(r,e,t,n,s){return de(this,void 0,void 0,function*(){return Ae(r,"POST",e,n,s,t)})}function Es(r,e,t,n,s){return de(this,void 0,void 0,function*(){return Ae(r,"PUT",e,n,s,t)})}function Gt(r,e,t,n,s){return de(this,void 0,void 0,function*(){return Ae(r,"DELETE",e,n,s,t)})}var K=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})};const Ts={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Kt={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class ws{constructor(e,t={},n,s){this.url=e,this.headers=t,this.bucketId=n,this.fetch=Ft(s)}uploadOrUpdate(e,t,n,s){return K(this,void 0,void 0,function*(){try{let i;const o=Object.assign(Object.assign({},Kt),s),c=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(o.upsert)});typeof Blob<"u"&&n instanceof Blob?(i=new FormData,i.append("cacheControl",o.cacheControl),i.append("",n)):typeof FormData<"u"&&n instanceof FormData?(i=n,i.append("cacheControl",o.cacheControl)):(i=n,c["cache-control"]=`max-age=${o.cacheControl}`,c["content-type"]=o.contentType);const l=this._removeEmptyFolders(t),a=this._getFinalPath(l),h=yield this.fetch(`${this.url}/object/${a}`,Object.assign({method:e,body:i,headers:c},o!=null&&o.duplex?{duplex:o.duplex}:{}));return h.ok?{data:{path:l},error:null}:{data:null,error:yield h.json()}}catch(i){if(D(i))return{data:null,error:i};throw i}})}upload(e,t,n){return K(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,n)})}uploadToSignedUrl(e,t,n,s){return K(this,void 0,void 0,function*(){const i=this._removeEmptyFolders(e),o=this._getFinalPath(i),c=new URL(this.url+`/object/upload/sign/${o}`);c.searchParams.set("token",t);try{let l;const a=Object.assign({upsert:Kt.upsert},s),h=Object.assign(Object.assign({},this.headers),{"x-upsert":String(a.upsert)});typeof Blob<"u"&&n instanceof Blob?(l=new FormData,l.append("cacheControl",a.cacheControl),l.append("",n)):typeof FormData<"u"&&n instanceof FormData?(l=n,l.append("cacheControl",a.cacheControl)):(l=n,h["cache-control"]=`max-age=${a.cacheControl}`,h["content-type"]=a.contentType);const f=yield this.fetch(c.toString(),{method:"PUT",body:l,headers:h});return f.ok?{data:{path:i},error:null}:{data:null,error:yield f.json()}}catch(l){if(D(l))return{data:null,error:l};throw l}})}createSignedUploadUrl(e){return K(this,void 0,void 0,function*(){try{let t=this._getFinalPath(e);const n=yield ee(this.fetch,`${this.url}/object/upload/sign/${t}`,{},{headers:this.headers}),s=new URL(this.url+n.url),i=s.searchParams.get("token");if(!i)throw new Qe("No token returned by API");return{data:{signedUrl:s.toString(),path:e,token:i},error:null}}catch(t){if(D(t))return{data:null,error:t};throw t}})}update(e,t,n){return K(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,n)})}move(e,t){return K(this,void 0,void 0,function*(){try{return{data:yield ee(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t},{headers:this.headers}),error:null}}catch(n){if(D(n))return{data:null,error:n};throw n}})}copy(e,t){return K(this,void 0,void 0,function*(){try{return{data:{path:(yield ee(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t},{headers:this.headers})).Key},error:null}}catch(n){if(D(n))return{data:null,error:n};throw n}})}createSignedUrl(e,t,n){return K(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e),i=yield ee(this.fetch,`${this.url}/object/sign/${s}`,Object.assign({expiresIn:t},n!=null&&n.transform?{transform:n.transform}:{}),{headers:this.headers});const o=n!=null&&n.download?`&download=${n.download===!0?"":n.download}`:"";return i={signedUrl:encodeURI(`${this.url}${i.signedURL}${o}`)},{data:i,error:null}}catch(s){if(D(s))return{data:null,error:s};throw s}})}createSignedUrls(e,t,n){return K(this,void 0,void 0,function*(){try{const s=yield ee(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),i=n!=null&&n.download?`&download=${n.download===!0?"":n.download}`:"";return{data:s.map(o=>Object.assign(Object.assign({},o),{signedUrl:o.signedURL?encodeURI(`${this.url}${o.signedURL}${i}`):null})),error:null}}catch(s){if(D(s))return{data:null,error:s};throw s}})}download(e,t){return K(this,void 0,void 0,function*(){const s=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",i=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),o=i?`?${i}`:"";try{const c=this._getFinalPath(e);return{data:yield(yield et(this.fetch,`${this.url}/${s}/${c}${o}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(c){if(D(c))return{data:null,error:c};throw c}})}getPublicUrl(e,t){const n=this._getFinalPath(e),s=[],i=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";i!==""&&s.push(i);const c=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",l=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});l!==""&&s.push(l);let a=s.join("&");return a!==""&&(a=`?${a}`),{data:{publicUrl:encodeURI(`${this.url}/${c}/public/${n}${a}`)}}}remove(e){return K(this,void 0,void 0,function*(){try{return{data:yield Gt(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(D(t))return{data:null,error:t};throw t}})}list(e,t,n){return K(this,void 0,void 0,function*(){try{const s=Object.assign(Object.assign(Object.assign({},Ts),t),{prefix:e||""});return{data:yield ee(this.fetch,`${this.url}/object/list/${this.bucketId}`,s,{headers:this.headers},n),error:null}}catch(s){if(D(s))return{data:null,error:s};throw s}})}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const Ss={"X-Client-Info":"storage-js/2.5.1"};var fe=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})};class Os{constructor(e,t={},n){this.url=e,this.headers=Object.assign(Object.assign({},Ss),t),this.fetch=Ft(n)}listBuckets(){return fe(this,void 0,void 0,function*(){try{return{data:yield et(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(D(e))return{data:null,error:e};throw e}})}getBucket(e){return fe(this,void 0,void 0,function*(){try{return{data:yield et(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(D(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return fe(this,void 0,void 0,function*(){try{return{data:yield ee(this.fetch,`${this.url}/bucket`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(n){if(D(n))return{data:null,error:n};throw n}})}updateBucket(e,t){return fe(this,void 0,void 0,function*(){try{return{data:yield Es(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(n){if(D(n))return{data:null,error:n};throw n}})}emptyBucket(e){return fe(this,void 0,void 0,function*(){try{return{data:yield ee(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(D(t))return{data:null,error:t};throw t}})}deleteBucket(e){return fe(this,void 0,void 0,function*(){try{return{data:yield Gt(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(D(t))return{data:null,error:t};throw t}})}}class As extends Os{constructor(e,t={},n){super(e,t,n)}from(e){return new ws(this.url,this.headers,e,this.fetch)}}const Rs={"X-Client-Info":"supabase-js/2.22.0"};var Cs=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})};const Ns=r=>{let e;return r?e=r:typeof fetch>"u"?e=Je:e=fetch,(...t)=>e(...t)},Is=()=>typeof Headers>"u"?Ke.Headers:Headers,$s=(r,e,t)=>{const n=Ns(t),s=Is();return(i,o)=>Cs(void 0,void 0,void 0,function*(){var c;const l=(c=yield e())!==null&&c!==void 0?c:r;let a=new s(o==null?void 0:o.headers);return a.has("apikey")||a.set("apikey",r),a.has("Authorization")||a.set("Authorization",`Bearer ${l}`),n(i,Object.assign(Object.assign({},o),{headers:a}))})};function Ps(r){return r.replace(/\/$/,"")}function ks(r,e){const{db:t,auth:n,realtime:s,global:i}=r,{db:o,auth:c,realtime:l,global:a}=e;return{db:Object.assign(Object.assign({},o),t),auth:Object.assign(Object.assign({},c),n),realtime:Object.assign(Object.assign({},l),s),global:Object.assign(Object.assign({},a),i)}}var ae=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})};function js(r){return Math.round(Date.now()/1e3)+r}function Us(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){const e=Math.random()*16|0;return(r=="x"?e:e&3|8).toString(16)})}const te=()=>typeof document<"u",ce={tested:!1,writable:!1},tt=()=>{if(!te())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(ce.tested)return ce.writable;const r=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(r,r),globalThis.localStorage.removeItem(r),ce.tested=!0,ce.writable=!0}catch{ce.tested=!0,ce.writable=!1}return ce.writable};function B(r,e){var t;e||(e=((t=window==null?void 0:window.location)===null||t===void 0?void 0:t.href)||""),r=r.replace(/[\[\]]/g,"\\$&");const n=new RegExp("[?&#]"+r+"(=([^&#]*)|&|#|$)"),s=n.exec(e);return s?s[2]?decodeURIComponent(s[2].replace(/\+/g," ")):"":null}const Jt=r=>{let e;return r?e=r:typeof fetch>"u"?e=(...t)=>ae(void 0,void 0,void 0,function*(){return yield(yield Promise.resolve().then(()=>Oe)).fetch(...t)}):e=fetch,(...t)=>e(...t)},Ds=r=>typeof r=="object"&&r!==null&&"status"in r&&"ok"in r&&"json"in r&&typeof r.json=="function",ye=(r,e,t)=>ae(void 0,void 0,void 0,function*(){yield r.setItem(e,JSON.stringify(t))}),Re=(r,e)=>ae(void 0,void 0,void 0,function*(){const t=yield r.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}}),rt=(r,e)=>ae(void 0,void 0,void 0,function*(){yield r.removeItem(e)});function Ls(r){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let t="",n,s,i,o,c,l,a,h=0;for(r=r.replace("-","+").replace("_","/");h<r.length;)o=e.indexOf(r.charAt(h++)),c=e.indexOf(r.charAt(h++)),l=e.indexOf(r.charAt(h++)),a=e.indexOf(r.charAt(h++)),n=o<<2|c>>4,s=(c&15)<<4|l>>2,i=(l&3)<<6|a,t=t+String.fromCharCode(n),l!=64&&s!=0&&(t=t+String.fromCharCode(s)),a!=64&&i!=0&&(t=t+String.fromCharCode(i));return t}class Ce{constructor(){this.promise=new Ce.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}Ce.promiseConstructor=Promise;function Xt(r){const e=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}=?$|[a-z0-9_-]{2}(==)?$)$/i,t=r.split(".");if(t.length!==3)throw new Error("JWT is not valid: not a JWT structure");if(!e.test(t[1]))throw new Error("JWT is not valid: payload is not in base64url format");const n=t[1];return JSON.parse(Ls(n))}function Ms(r){return new Promise(e=>{setTimeout(()=>e(null),r)})}function xs(r,e){return new Promise((n,s)=>{ae(this,void 0,void 0,function*(){for(let i=0;i<1/0;i++)try{const o=yield r(i);if(!e(i,null,o)){n(o);return}}catch(o){if(!e(i,o)){s(o);return}}})})}function Hs(r){return("0"+r.toString(16)).substr(-2)}function Ne(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",n=t.length;let s="";for(let i=0;i<56;i++)s+=t.charAt(Math.floor(Math.random()*n));return s}return crypto.getRandomValues(e),Array.from(e,Hs).join("")}function Bs(r){return ae(this,void 0,void 0,function*(){const t=new TextEncoder().encode(r),n=yield crypto.subtle.digest("SHA-256",t),s=new Uint8Array(n);return Array.from(s).map(i=>String.fromCharCode(i)).join("")})}function Fs(r){return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Ie(r){return ae(this,void 0,void 0,function*(){if(typeof crypto>"u")return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),r;const e=yield Bs(r);return Fs(e)})}class nt extends Error{constructor(e,t){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t}}function O(r){return typeof r=="object"&&r!==null&&"__isAuthError"in r}class Gs extends nt{constructor(e,t){super(e,t),this.name="AuthApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}function Ks(r){return O(r)&&r.name==="AuthApiError"}class zt extends nt{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class ve extends nt{constructor(e,t,n){super(e),this.name=t,this.status=n}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class be extends ve{constructor(){super("Auth session missing!","AuthSessionMissingError",400)}}class $e extends ve{constructor(e){super(e,"AuthInvalidCredentialsError",400)}}class Z extends ve{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class st extends ve{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class it extends ve{constructor(e,t){super(e,"AuthRetryableFetchError",t)}}var ot=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})},Js=globalThis&&globalThis.__rest||function(r,e){var t={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,n=Object.getOwnPropertySymbols(r);s<n.length;s++)e.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(r,n[s])&&(t[n[s]]=r[n[s]]);return t};const Pe=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),Xs=(r,e)=>ot(void 0,void 0,void 0,function*(){const t=[502,503,504];Ds(r)?t.includes(r.status)?e(new it(Pe(r),r.status)):r.json().then(n=>{e(new Gs(Pe(n),r.status||500))}).catch(n=>{e(new zt(Pe(n),n))}):e(new it(Pe(r),0))}),zs=(r,e,t,n)=>{const s={method:r,headers:(e==null?void 0:e.headers)||{}};return r==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),s.body=JSON.stringify(n),Object.assign(Object.assign({},s),t))};function R(r,e,t,n){var s;return ot(this,void 0,void 0,function*(){const i=Object.assign({},n==null?void 0:n.headers);n!=null&&n.jwt&&(i.Authorization=`Bearer ${n.jwt}`);const o=(s=n==null?void 0:n.query)!==null&&s!==void 0?s:{};n!=null&&n.redirectTo&&(o.redirect_to=n.redirectTo);const c=Object.keys(o).length?"?"+new URLSearchParams(o).toString():"",l=yield Ys(r,e,t+c,{headers:i,noResolveJson:n==null?void 0:n.noResolveJson},{},n==null?void 0:n.body);return n!=null&&n.xform?n==null?void 0:n.xform(l):{data:Object.assign({},l),error:null}})}function Ys(r,e,t,n,s,i){return ot(this,void 0,void 0,function*(){return new Promise((o,c)=>{r(t,zs(e,n,s,i)).then(l=>{if(!l.ok)throw l;return n!=null&&n.noResolveJson?l:l.json()}).then(l=>o(l)).catch(l=>Xs(l,c))})})}function re(r){var e;let t=null;Qs(r)&&(t=Object.assign({},r),t.expires_at=js(r.expires_in));const n=(e=r.user)!==null&&e!==void 0?e:r;return{data:{session:t,user:n},error:null}}function le(r){var e;return{data:{user:(e=r.user)!==null&&e!==void 0?e:r},error:null}}function Ws(r){return{data:r,error:null}}function Vs(r){const{action_link:e,email_otp:t,hashed_token:n,redirect_to:s,verification_type:i}=r,o=Js(r,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),c={action_link:e,email_otp:t,hashed_token:n,redirect_to:s,verification_type:i},l=Object.assign({},o);return{data:{properties:c,user:l},error:null}}function qs(r){return r}function Qs(r){return r.access_token&&r.refresh_token&&r.expires_in}var V=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})},Zs=globalThis&&globalThis.__rest||function(r,e){var t={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,n=Object.getOwnPropertySymbols(r);s<n.length;s++)e.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(r,n[s])&&(t[n[s]]=r[n[s]]);return t};class ei{constructor({url:e="",headers:t={},fetch:n}){this.url=e,this.headers=t,this.fetch=Jt(n),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}signOut(e){return V(this,void 0,void 0,function*(){try{return yield R(this.fetch,"POST",`${this.url}/logout`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(t){if(O(t))return{data:null,error:t};throw t}})}inviteUserByEmail(e,t={}){return V(this,void 0,void 0,function*(){try{return yield R(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:le})}catch(n){if(O(n))return{data:{user:null},error:n};throw n}})}generateLink(e){return V(this,void 0,void 0,function*(){try{const{options:t}=e,n=Zs(e,["options"]),s=Object.assign(Object.assign({},n),t);return"newEmail"in n&&(s.new_email=n==null?void 0:n.newEmail,delete s.newEmail),yield R(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:s,headers:this.headers,xform:Vs,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(O(t))return{data:{properties:null,user:null},error:t};throw t}})}createUser(e){return V(this,void 0,void 0,function*(){try{return yield R(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:le})}catch(t){if(O(t))return{data:{user:null},error:t};throw t}})}listUsers(e){var t,n,s,i,o,c,l;return V(this,void 0,void 0,function*(){try{const a={nextPage:null,lastPage:0,total:0},h=yield R(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(n=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:"",per_page:(i=(s=e==null?void 0:e.perPage)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""},xform:qs});if(h.error)throw h.error;const f=yield h.json(),p=(o=h.headers.get("x-total-count"))!==null&&o!==void 0?o:0,g=(l=(c=h.headers.get("link"))===null||c===void 0?void 0:c.split(","))!==null&&l!==void 0?l:[];return g.length>0&&(g.forEach(m=>{const b=parseInt(m.split(";")[0].split("=")[1].substring(0,1)),v=JSON.parse(m.split(";")[1].split("=")[1]);a[`${v}Page`]=b}),a.total=parseInt(p)),{data:Object.assign(Object.assign({},f),a),error:null}}catch(a){if(O(a))return{data:{users:[]},error:a};throw a}})}getUserById(e){return V(this,void 0,void 0,function*(){try{return yield R(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:le})}catch(t){if(O(t))return{data:{user:null},error:t};throw t}})}updateUserById(e,t){return V(this,void 0,void 0,function*(){try{return yield R(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:le})}catch(n){if(O(n))return{data:{user:null},error:n};throw n}})}deleteUser(e,t=!1){return V(this,void 0,void 0,function*(){try{return yield R(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:le})}catch(n){if(O(n))return{data:{user:null},error:n};throw n}})}_listFactors(e){return V(this,void 0,void 0,function*(){try{const{data:t,error:n}=yield R(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:s=>({data:{factors:s},error:null})});return{data:t,error:n}}catch(t){if(O(t))return{data:null,error:t};throw t}})}_deleteFactor(e){return V(this,void 0,void 0,function*(){try{return{data:yield R(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(O(t))return{data:null,error:t};throw t}})}}const ti="2.27.0",ri="http://localhost:9999",ni="supabase.auth.token",si={"X-Client-Info":`gotrue-js/${ti}`},ii=10,oi={getItem:r=>tt()?globalThis.localStorage.getItem(r):null,setItem:(r,e)=>{tt()&&globalThis.localStorage.setItem(r,e)},removeItem:r=>{tt()&&globalThis.localStorage.removeItem(r)}};function ai(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}var E=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})};ai();const ci={url:ri,storageKey:ni,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:si,flowType:"implicit"},at=30*1e3,li=3;class hi{constructor(e){var t;this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.broadcastChannel=null;const n=Object.assign(Object.assign({},ci),e);if(this.inMemorySession=null,this.storageKey=n.storageKey,this.autoRefreshToken=n.autoRefreshToken,this.persistSession=n.persistSession,this.storage=n.storage||oi,this.admin=new ei({url:n.url,headers:n.headers,fetch:n.fetch}),this.url=n.url,this.headers=n.headers,this.fetch=Jt(n.fetch),this.detectSessionInUrl=n.detectSessionInUrl,this.flowType=n.flowType,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},te()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(s){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",s)}(t=this.broadcastChannel)===null||t===void 0||t.addEventListener("message",s=>{this._notifyAllSubscribers(s.data.event,s.data.session,!1)})}this.initialize()}initialize(){return this.initializePromise||(this.initializePromise=this._initialize()),this.initializePromise}_initialize(){return E(this,void 0,void 0,function*(){if(this.initializePromise)return this.initializePromise;try{const e=yield this._isPKCEFlow();if(this.detectSessionInUrl&&this._isImplicitGrantFlow()||e){const{data:t,error:n}=yield this._getSessionFromUrl(e);if(n)return yield this._removeSession(),{error:n};const{session:s,redirectType:i}=t;return yield this._saveSession(s),setTimeout(()=>{i==="recovery"?this._notifyAllSubscribers("PASSWORD_RECOVERY",s):this._notifyAllSubscribers("SIGNED_IN",s)},0),{error:null}}return yield this._recoverAndRefresh(),{error:null}}catch(e){return O(e)?{error:e}:{error:new zt("Unexpected error during initialization",e)}}finally{yield this._handleVisibilityChange()}})}signUp(e){var t,n,s;return E(this,void 0,void 0,function*(){try{yield this._removeSession();let i;if("email"in e){const{email:h,password:f,options:p}=e;let g=null,m=null;if(this.flowType==="pkce"){const b=Ne();yield ye(this.storage,`${this.storageKey}-code-verifier`,b),g=yield Ie(b),m=b===g?"plain":"s256"}i=yield R(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:p==null?void 0:p.emailRedirectTo,body:{email:h,password:f,data:(t=p==null?void 0:p.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:p==null?void 0:p.captchaToken},code_challenge:g,code_challenge_method:m},xform:re})}else if("phone"in e){const{phone:h,password:f,options:p}=e;i=yield R(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:h,password:f,data:(n=p==null?void 0:p.data)!==null&&n!==void 0?n:{},channel:(s=p==null?void 0:p.channel)!==null&&s!==void 0?s:"sms",gotrue_meta_security:{captcha_token:p==null?void 0:p.captchaToken}},xform:re})}else throw new $e("You must provide either an email or phone number and a password");const{data:o,error:c}=i;if(c||!o)return{data:{user:null,session:null},error:c};const l=o.session,a=o.user;return o.session&&(yield this._saveSession(o.session),this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:a,session:l},error:null}}catch(i){if(O(i))return{data:{user:null,session:null},error:i};throw i}})}signInWithPassword(e){return E(this,void 0,void 0,function*(){try{yield this._removeSession();let t;if("email"in e){const{email:i,password:o,options:c}=e;t=yield R(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:o,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken}},xform:re})}else if("phone"in e){const{phone:i,password:o,options:c}=e;t=yield R(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:o,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken}},xform:re})}else throw new $e("You must provide either an email or phone number and a password");const{data:n,error:s}=t;return s||!n?{data:{user:null,session:null},error:s}:(n.session&&(yield this._saveSession(n.session),this._notifyAllSubscribers("SIGNED_IN",n.session)),{data:n,error:s})}catch(t){if(O(t))return{data:{user:null,session:null},error:t};throw t}})}signInWithOAuth(e){var t,n,s,i;return E(this,void 0,void 0,function*(){return yield this._removeSession(),yield this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(n=e.options)===null||n===void 0?void 0:n.scopes,queryParams:(s=e.options)===null||s===void 0?void 0:s.queryParams,skipBrowserRedirect:(i=e.options)===null||i===void 0?void 0:i.skipBrowserRedirect})})}exchangeCodeForSession(e){return E(this,void 0,void 0,function*(){const t=yield Re(this.storage,`${this.storageKey}-code-verifier`),{data:n,error:s}=yield R(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:t},xform:re});return yield rt(this.storage,`${this.storageKey}-code-verifier`),s||!n?{data:{user:null,session:null},error:s}:(n.session&&(yield this._saveSession(n.session),this._notifyAllSubscribers("SIGNED_IN",n.session)),{data:n,error:s})})}signInWithIdToken(e){return E(this,void 0,void 0,function*(){yield this._removeSession();try{const{options:t,provider:n,token:s,nonce:i}=e,o=yield R(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:n,id_token:s,nonce:i,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:re}),{data:c,error:l}=o;return l||!c?{data:{user:null,session:null},error:l}:(c.session&&(yield this._saveSession(c.session),this._notifyAllSubscribers("SIGNED_IN",c.session)),{data:c,error:l})}catch(t){if(O(t))return{data:{user:null,session:null},error:t};throw t}})}signInWithOtp(e){var t,n,s,i,o;return E(this,void 0,void 0,function*(){try{if(yield this._removeSession(),"email"in e){const{email:c,options:l}=e;let a=null,h=null;if(this.flowType==="pkce"){const p=Ne();yield ye(this.storage,`${this.storageKey}-code-verifier`,p),a=yield Ie(p),h=p===a?"plain":"s256"}const{error:f}=yield R(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:c,data:(t=l==null?void 0:l.data)!==null&&t!==void 0?t:{},create_user:(n=l==null?void 0:l.shouldCreateUser)!==null&&n!==void 0?n:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},code_challenge:a,code_challenge_method:h},redirectTo:l==null?void 0:l.emailRedirectTo});return{data:{user:null,session:null},error:f}}if("phone"in e){const{phone:c,options:l}=e,{error:a}=yield R(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:c,data:(s=l==null?void 0:l.data)!==null&&s!==void 0?s:{},create_user:(i=l==null?void 0:l.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},channel:(o=l==null?void 0:l.channel)!==null&&o!==void 0?o:"sms"}});return{data:{user:null,session:null},error:a}}throw new $e("You must provide either an email or phone number.")}catch(c){if(O(c))return{data:{user:null,session:null},error:c};throw c}})}verifyOtp(e){var t,n;return E(this,void 0,void 0,function*(){try{yield this._removeSession();const{data:s,error:i}=yield R(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:(t=e.options)===null||t===void 0?void 0:t.captchaToken}}),redirectTo:(n=e.options)===null||n===void 0?void 0:n.redirectTo,xform:re});if(i)throw i;if(!s)throw new Error("An error occurred on token verification.");const o=s.session,c=s.user;return o!=null&&o.access_token&&(yield this._saveSession(o),this._notifyAllSubscribers("SIGNED_IN",o)),{data:{user:c,session:o},error:null}}catch(s){if(O(s))return{data:{user:null,session:null},error:s};throw s}})}signInWithSSO(e){var t,n,s;return E(this,void 0,void 0,function*(){try{return yield this._removeSession(),yield R(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(n=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&n!==void 0?n:void 0}),!((s=e==null?void 0:e.options)===null||s===void 0)&&s.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0}),headers:this.headers,xform:Ws})}catch(i){if(O(i))return{data:null,error:i};throw i}})}resend(e){return E(this,void 0,void 0,function*(){try{yield this._removeSession();const t=`${this.url}/resend`;if("email"in e){const{email:n,type:s,options:i}=e,{error:o}=yield R(this.fetch,"POST",t,{headers:this.headers,body:{email:n,type:s,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}}});return{data:{user:null,session:null},error:o}}else if("phone"in e){const{phone:n,type:s,options:i}=e,{error:o}=yield R(this.fetch,"POST",t,{headers:this.headers,body:{phone:n,type:s,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}}});return{data:{user:null,session:null},error:o}}throw new $e("You must provide either an email or phone number and a type")}catch(t){if(O(t))return{data:{user:null,session:null},error:t};throw t}})}getSession(){return E(this,void 0,void 0,function*(){yield this.initializePromise;let e=null;if(this.persistSession){const i=yield Re(this.storage,this.storageKey);i!==null&&(this._isValidSession(i)?e=i:yield this._removeSession())}else e=this.inMemorySession;if(!e)return{data:{session:null},error:null};if(!(e.expires_at?e.expires_at<=Date.now()/1e3:!1))return{data:{session:e},error:null};const{session:n,error:s}=yield this._callRefreshToken(e.refresh_token);return s?{data:{session:null},error:s}:{data:{session:n},error:null}})}getUser(e){var t,n;return E(this,void 0,void 0,function*(){try{if(!e){const{data:s,error:i}=yield this.getSession();if(i)throw i;e=(n=(t=s.session)===null||t===void 0?void 0:t.access_token)!==null&&n!==void 0?n:void 0}return yield R(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:le})}catch(s){if(O(s))return{data:{user:null},error:s};throw s}})}updateUser(e,t={}){return E(this,void 0,void 0,function*(){try{const{data:n,error:s}=yield this.getSession();if(s)throw s;if(!n.session)throw new be;const i=n.session,{data:o,error:c}=yield R(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:e,jwt:i.access_token,xform:le});if(c)throw c;return i.user=o.user,yield this._saveSession(i),this._notifyAllSubscribers("USER_UPDATED",i),{data:{user:i.user},error:null}}catch(n){if(O(n))return{data:{user:null},error:n};throw n}})}_decodeJWT(e){return Xt(e)}setSession(e){return E(this,void 0,void 0,function*(){try{if(!e.access_token||!e.refresh_token)throw new be;const t=Date.now()/1e3;let n=t,s=!0,i=null;const o=Xt(e.access_token);if(o.exp&&(n=o.exp,s=n<=t),s){const{session:c,error:l}=yield this._callRefreshToken(e.refresh_token);if(l)return{data:{user:null,session:null},error:l};if(!c)return{data:{user:null,session:null},error:null};i=c}else{const{data:c,error:l}=yield this.getUser(e.access_token);if(l)throw l;i={access_token:e.access_token,refresh_token:e.refresh_token,user:c.user,token_type:"bearer",expires_in:n-t,expires_at:n},yield this._saveSession(i),this._notifyAllSubscribers("SIGNED_IN",i)}return{data:{user:i.user,session:i},error:null}}catch(t){if(O(t))return{data:{session:null,user:null},error:t};throw t}})}refreshSession(e){var t;return E(this,void 0,void 0,function*(){try{if(!e){const{data:i,error:o}=yield this.getSession();if(o)throw o;e=(t=i.session)!==null&&t!==void 0?t:void 0}if(!(e!=null&&e.refresh_token))throw new be;const{session:n,error:s}=yield this._callRefreshToken(e.refresh_token);return s?{data:{user:null,session:null},error:s}:n?{data:{user:n.user,session:n},error:null}:{data:{user:null,session:null},error:null}}catch(n){if(O(n))return{data:{user:null,session:null},error:n};throw n}})}_getSessionFromUrl(e){return E(this,void 0,void 0,function*(){try{if(!te())throw new Z("No browser detected.");if(this.flowType==="implicit"&&!this._isImplicitGrantFlow())throw new Z("Not a valid implicit grant flow url.");if(this.flowType=="pkce"&&!e)throw new st("Not a valid PKCE flow url.");if(e){const v=B("code");if(!v)throw new st("No code detected.");const{data:C,error:k}=yield this.exchangeCodeForSession(v);if(k)throw k;if(!C.session)throw new st("No session detected.");let F=new URL(window.location.href);return F.searchParams.delete("code"),window.history.replaceState(window.history.state,"",F.toString()),{data:{session:C.session,redirectType:null},error:null}}const t=B("error_description");if(t){const v=B("error_code");if(!v)throw new Z("No error_code detected.");const C=B("error");throw C?new Z(t,{error:C,code:v}):new Z("No error detected.")}const n=B("provider_token"),s=B("provider_refresh_token"),i=B("access_token");if(!i)throw new Z("No access_token detected.");const o=B("expires_in");if(!o)throw new Z("No expires_in detected.");const c=B("refresh_token");if(!c)throw new Z("No refresh_token detected.");const l=B("token_type");if(!l)throw new Z("No token_type detected.");const h=Math.round(Date.now()/1e3)+parseInt(o),{data:f,error:p}=yield this.getUser(i);if(p)throw p;const g=f.user,m={provider_token:n,provider_refresh_token:s,access_token:i,expires_in:parseInt(o),expires_at:h,refresh_token:c,token_type:l,user:g},b=B("type");return window.location.hash="",{data:{session:m,redirectType:b},error:null}}catch(t){if(O(t))return{data:{session:null,redirectType:null},error:t};throw t}})}_isImplicitGrantFlow(){return te()&&(!!B("access_token")||!!B("error_description"))}_isPKCEFlow(){return E(this,void 0,void 0,function*(){const e=yield Re(this.storage,`${this.storageKey}-code-verifier`);return te()&&!!B("code")&&!!e})}signOut(){var e;return E(this,void 0,void 0,function*(){const{data:t,error:n}=yield this.getSession();if(n)return{error:n};const s=(e=t.session)===null||e===void 0?void 0:e.access_token;if(s){const{error:i}=yield this.admin.signOut(s);if(i&&!(Ks(i)&&(i.status===404||i.status===401)))return{error:i}}return yield this._removeSession(),yield rt(this.storage,`${this.storageKey}-code-verifier`),this._notifyAllSubscribers("SIGNED_OUT",null),{error:null}})}onAuthStateChange(e){const t=Us(),n={id:t,callback:e,unsubscribe:()=>{this.stateChangeEmitters.delete(t)}};return this.stateChangeEmitters.set(t,n),this.emitInitialSession(t),{data:{subscription:n}}}emitInitialSession(e){var t,n;return E(this,void 0,void 0,function*(){try{const{data:{session:s},error:i}=yield this.getSession();if(i)throw i;(t=this.stateChangeEmitters.get(e))===null||t===void 0||t.callback("INITIAL_SESSION",s)}catch(s){(n=this.stateChangeEmitters.get(e))===null||n===void 0||n.callback("INITIAL_SESSION",null),console.error(s)}})}resetPasswordForEmail(e,t={}){return E(this,void 0,void 0,function*(){let n=null,s=null;if(this.flowType==="pkce"){const i=Ne();yield ye(this.storage,`${this.storageKey}-code-verifier`,i),n=yield Ie(i),s=i===n?"plain":"s256"}try{return yield R(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:n,code_challenge_method:s,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(i){if(O(i))return{data:null,error:i};throw i}})}_refreshAccessToken(e){return E(this,void 0,void 0,function*(){try{const t=Date.now();return yield xs(n=>E(this,void 0,void 0,function*(){return yield Ms(n*200),yield R(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:re})}),(n,s,i)=>i&&i.error&&i.error instanceof it&&Date.now()+(n+1)*200-t<at)}catch(t){if(O(t))return{data:{session:null,user:null},error:t};throw t}})}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}_handleProviderSignIn(e,t){return E(this,void 0,void 0,function*(){const n=yield this._getUrlForProvider(e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return te()&&!t.skipBrowserRedirect&&window.location.assign(n),{data:{provider:e,url:n},error:null}})}_recoverAndRefresh(){var e;return E(this,void 0,void 0,function*(){try{const t=yield Re(this.storage,this.storageKey);if(!this._isValidSession(t)){t!==null&&(yield this._removeSession());return}const n=Math.round(Date.now()/1e3);if(((e=t.expires_at)!==null&&e!==void 0?e:1/0)<n+ii){if(this.autoRefreshToken&&t.refresh_token){const{error:s}=yield this._callRefreshToken(t.refresh_token);s&&(console.log(s.message),yield this._removeSession())}}else this.persistSession&&(yield this._saveSession(t)),this._notifyAllSubscribers("SIGNED_IN",t)}catch(t){console.error(t);return}})}_callRefreshToken(e){var t,n;return E(this,void 0,void 0,function*(){if(this.refreshingDeferred)return this.refreshingDeferred.promise;try{if(this.refreshingDeferred=new Ce,!e)throw new be;const{data:s,error:i}=yield this._refreshAccessToken(e);if(i)throw i;if(!s.session)throw new be;yield this._saveSession(s.session),this._notifyAllSubscribers("TOKEN_REFRESHED",s.session);const o={session:s.session,error:null};return this.refreshingDeferred.resolve(o),o}catch(s){if(O(s)){const i={session:null,error:s};return(t=this.refreshingDeferred)===null||t===void 0||t.resolve(i),i}throw(n=this.refreshingDeferred)===null||n===void 0||n.reject(s),s}finally{this.refreshingDeferred=null}})}_notifyAllSubscribers(e,t,n=!0){this.broadcastChannel&&n&&this.broadcastChannel.postMessage({event:e,session:t}),this.stateChangeEmitters.forEach(s=>s.callback(e,t))}_saveSession(e){return E(this,void 0,void 0,function*(){this.persistSession||(this.inMemorySession=e),this.persistSession&&e.expires_at&&(yield this._persistSession(e))})}_persistSession(e){return ye(this.storage,this.storageKey,e)}_removeSession(){return E(this,void 0,void 0,function*(){this.persistSession?yield rt(this.storage,this.storageKey):this.inMemorySession=null})}_removeVisibilityChangedCallback(){const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&te()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}_startAutoRefresh(){return E(this,void 0,void 0,function*(){yield this._stopAutoRefresh();const e=setInterval(()=>this._autoRefreshTokenTick(),at);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),yield this._autoRefreshTokenTick()})}_stopAutoRefresh(){return E(this,void 0,void 0,function*(){const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)})}startAutoRefresh(){return E(this,void 0,void 0,function*(){this._removeVisibilityChangedCallback(),yield this._startAutoRefresh()})}stopAutoRefresh(){return E(this,void 0,void 0,function*(){this._removeVisibilityChangedCallback(),yield this._stopAutoRefresh()})}_autoRefreshTokenTick(){return E(this,void 0,void 0,function*(){const e=Date.now();try{const{data:{session:t}}=yield this.getSession();if(!t||!t.refresh_token||!t.expires_at)return;Math.floor((t.expires_at*1e3-e)/at)<li&&(yield this._callRefreshToken(t.refresh_token))}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}})}_handleVisibilityChange(){return E(this,void 0,void 0,function*(){if(!te()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=()=>E(this,void 0,void 0,function*(){return yield this._onVisibilityChanged(!1)}),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),yield this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}})}_onVisibilityChanged(e){return E(this,void 0,void 0,function*(){document.visibilityState==="visible"?(e||(yield this.initializePromise,yield this._recoverAndRefresh()),this.autoRefreshToken&&this._startAutoRefresh()):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()})}_getUrlForProvider(e,t){return E(this,void 0,void 0,function*(){const n=[`provider=${encodeURIComponent(e)}`];if(t!=null&&t.redirectTo&&n.push(`redirect_to=${encodeURIComponent(t.redirectTo)}`),t!=null&&t.scopes&&n.push(`scopes=${encodeURIComponent(t.scopes)}`),this.flowType==="pkce"){const s=Ne();yield ye(this.storage,`${this.storageKey}-code-verifier`,s);const i=yield Ie(s),o=s===i?"plain":"s256",c=new URLSearchParams({code_challenge:`${encodeURIComponent(i)}`,code_challenge_method:`${encodeURIComponent(o)}`});n.push(c.toString())}if(t!=null&&t.queryParams){const s=new URLSearchParams(t.queryParams);n.push(s.toString())}return`${this.url}/authorize?${n.join("&")}`})}_unenroll(e){var t;return E(this,void 0,void 0,function*(){try{const{data:n,error:s}=yield this.getSession();return s?{data:null,error:s}:yield R(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(t=n==null?void 0:n.session)===null||t===void 0?void 0:t.access_token})}catch(n){if(O(n))return{data:null,error:n};throw n}})}_enroll(e){var t,n;return E(this,void 0,void 0,function*(){try{const{data:s,error:i}=yield this.getSession();if(i)return{data:null,error:i};const{data:o,error:c}=yield R(this.fetch,"POST",`${this.url}/factors`,{body:{friendly_name:e.friendlyName,factor_type:e.factorType,issuer:e.issuer},headers:this.headers,jwt:(t=s==null?void 0:s.session)===null||t===void 0?void 0:t.access_token});return c?{data:null,error:c}:(!((n=o==null?void 0:o.totp)===null||n===void 0)&&n.qr_code&&(o.totp.qr_code=`data:image/svg+xml;utf-8,${o.totp.qr_code}`),{data:o,error:null})}catch(s){if(O(s))return{data:null,error:s};throw s}})}_verify(e){var t;return E(this,void 0,void 0,function*(){try{const{data:n,error:s}=yield this.getSession();if(s)return{data:null,error:s};const{data:i,error:o}=yield R(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(t=n==null?void 0:n.session)===null||t===void 0?void 0:t.access_token});return o?{data:null,error:o}:(yield this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+i.expires_in},i)),this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",i),{data:i,error:o})}catch(n){if(O(n))return{data:null,error:n};throw n}})}_challenge(e){var t;return E(this,void 0,void 0,function*(){try{const{data:n,error:s}=yield this.getSession();return s?{data:null,error:s}:yield R(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{headers:this.headers,jwt:(t=n==null?void 0:n.session)===null||t===void 0?void 0:t.access_token})}catch(n){if(O(n))return{data:null,error:n};throw n}})}_challengeAndVerify(e){return E(this,void 0,void 0,function*(){const{data:t,error:n}=yield this._challenge({factorId:e.factorId});return n?{data:null,error:n}:yield this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})})}_listFactors(){return E(this,void 0,void 0,function*(){const{data:{user:e},error:t}=yield this.getUser();if(t)return{data:null,error:t};const n=(e==null?void 0:e.factors)||[],s=n.filter(i=>i.factor_type==="totp"&&i.status==="verified");return{data:{all:n,totp:s},error:null}})}_getAuthenticatorAssuranceLevel(){var e,t;return E(this,void 0,void 0,function*(){const{data:{session:n},error:s}=yield this.getSession();if(s)return{data:null,error:s};if(!n)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const i=this._decodeJWT(n.access_token);let o=null;i.aal&&(o=i.aal);let c=o;((t=(e=n.user.factors)===null||e===void 0?void 0:e.filter(h=>h.status==="verified"))!==null&&t!==void 0?t:[]).length>0&&(c="aal2");const a=i.amr||[];return{data:{currentLevel:o,nextLevel:c,currentAuthenticationMethods:a},error:null}})}}class ui extends hi{constructor(e){super(e)}}var di=globalThis&&globalThis.__awaiter||function(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(h){try{a(n.next(h))}catch(f){o(f)}}function l(h){try{a(n.throw(h))}catch(f){o(f)}}function a(h){h.done?i(h.value):s(h.value).then(c,l)}a((n=n.apply(r,e||[])).next())})};const fi={headers:Rs},pi={schema:"public"},_i={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},mi={};class gi{constructor(e,t,n){var s,i,o,c,l,a,h,f;if(this.supabaseUrl=e,this.supabaseKey=t,!e)throw new Error("supabaseUrl is required.");if(!t)throw new Error("supabaseKey is required.");const p=Ps(e);if(this.realtimeUrl=`${p}/realtime/v1`.replace(/^http/i,"ws"),this.authUrl=`${p}/auth/v1`,this.storageUrl=`${p}/storage/v1`,p.match(/(supabase\.co)|(supabase\.in)/)){const C=p.split(".");this.functionsUrl=`${C[0]}.functions.${C[1]}.${C[2]}`}else this.functionsUrl=`${p}/functions/v1`;const m=`sb-${new URL(this.authUrl).hostname.split(".")[0]}-auth-token`,b={db:pi,realtime:mi,auth:Object.assign(Object.assign({},_i),{storageKey:m}),global:fi},v=ks(n??{},b);this.storageKey=(i=(s=v.auth)===null||s===void 0?void 0:s.storageKey)!==null&&i!==void 0?i:"",this.headers=(c=(o=v.global)===null||o===void 0?void 0:o.headers)!==null&&c!==void 0?c:{},this.auth=this._initSupabaseAuthClient((l=v.auth)!==null&&l!==void 0?l:{},this.headers,(a=v.global)===null||a===void 0?void 0:a.fetch),this.fetch=$s(t,this._getAccessToken.bind(this),(h=v.global)===null||h===void 0?void 0:h.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers},v.realtime)),this.rest=new es(`${p}/rest/v1`,{headers:this.headers,schema:(f=v.db)===null||f===void 0?void 0:f.schema,fetch:this.fetch}),this._listenForAuthEvents()}get functions(){return new zn(this.functionsUrl,{headers:this.headers,customFetch:this.fetch})}get storage(){return new As(this.storageUrl,this.headers,this.fetch)}from(e){return this.rest.from(e)}rpc(e,t={},n){return this.rest.rpc(e,t,n)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return di(this,void 0,void 0,function*(){const{data:n}=yield this.auth.getSession();return(t=(e=n.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:null})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:n,storage:s,storageKey:i,flowType:o},c,l){const a={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new ui({url:this.authUrl,headers:Object.assign(Object.assign({},a),c),storageKey:i,autoRefreshToken:e,persistSession:t,detectSessionInUrl:n,storage:s,flowType:o,fetch:l})}_initRealtimeClient(e){return new ms(this.realtimeUrl,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,n)=>{this._handleTokenChanged(t,n==null?void 0:n.access_token,"CLIENT")})}_handleTokenChanged(e,t,n){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==t?(this.realtime.setAuth(t??null),this.changedAccessToken=t):e==="SIGNED_OUT"&&(this.realtime.setAuth(this.supabaseKey),n=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const yi=(r,e,t)=>new gi(r,e,t);var vi=Object.defineProperty,bi=(r,e,t)=>e in r?vi(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Yt=(r,e,t)=>(bi(r,typeof e!="symbol"?e+"":e,t),t);let Ei=class extends Ln{constructor(e,t){super(e,t),Yt(this,"client"),Yt(this,"storageUrl"),this.client=yi(this.config.url,this.config.anonKey),this.storageUrl=`${this.config.url}/storage/v1/object/public/${this.config.bucket}`}async create(e){if(!e&&!this.data)throw new Error("ImageStorage error: No Storage Data");const t=e||this.data,{error:n}=await this.client.storage.from(this.config.bucket).upload(t.imgPath,t.imgData,{contentType:"image/svg+xml",cacheControl:"31536000",upsert:this.config.upsert||!0});if(n)throw n;return{url:`${this.storageUrl}/${t.imgPath}?v=starnexusogimage&t=${Date.now()}`}}async update(e){if(!e&&!this.data)throw new Error("ImageStorage error: No Storage Data");const t=e||this.data,{error:n}=await this.client.storage.from(this.config.bucket).update(t.imgPath,t.imgData,{contentType:"image/svg+xml",cacheControl:"31536000"});if(n)throw n;return{url:`${this.storageUrl}/${t.imgPath}?v=starnexusogimage&t=${Date.now()}`}}async query(e){const t=`${this.storageUrl}/${e}`;return{url:await W(t).then(n=>t).catch(n=>"")}}getConfig(){return this.config}getType(){return{type:"ImageStorage",name:"SupabaseImageStorage"}}};var Ti=Object.defineProperty,wi=(r,e,t)=>e in r?Ti(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Ee=(r,e,t)=>(wi(r,typeof e!="symbol"?e+"":e,t),t);let Si=class{constructor(e){Ee(this,"apiUrl","/api/webcard"),Ee(this,"headers"),Ee(this,"webData"),Ee(this,"imgStorage"),Ee(this,"localFn"),this.apiUrl=(e.starNexusHub||"")+this.apiUrl,this.webData=e.webData,this.headers=e.headers,this.localFn=e.localFn,this.imgStorage=e.imgStorage}async call(e){if(!e.webData&&!this.webData)throw new Error("WebCard error: No WebInfo Data");const t=e.webData||this.webData;let n,s;if(this.localFn)n=await this.localFn(t),(await this.imgStorage.query(n.imgPath)).url?s=await this.imgStorage.update(n):s=await this.imgStorage.create(n),await e.dataStorage.updateOgImage(e.savedData,s.url);else{const i=this.imgStorage.getType(),o=this.imgStorage.getConfig(),c=e.dataStorage.getType(),l=e.dataStorage.getConfig();s=await W(this.apiUrl,{method:"POST",headers:this.headers,body:{webData:t,imgType:i,imgCfg:o,dataType:c,dataCfg:l,savedData:e.savedData}})}return s}};var Oi=Object.defineProperty,Ai=(r,e,t)=>e in r?Oi(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,ke=(r,e,t)=>(Ai(r,typeof e!="symbol"?e+"":e,t),t);let Ri=class{constructor(e){ke(this,"webUrl",""),ke(this,"apiUrl","/api/webinfo"),ke(this,"starNexusHub",""),ke(this,"headers"),this.webUrl=e.urls.webUrl,this.headers=e.headers,this.starNexusHub=e.starNexusHub||""}async call(){if(!this.starNexusHub)throw new Error("StarNexus error: No StarNexusHub API.");return await W(this.starNexusHub+this.apiUrl,{method:"POST",headers:this.headers,body:{webUrl:this.webUrl}})}getStarNuxesApi(){return this.starNexusHub}};var Ci=Object.defineProperty,Ni=(r,e,t)=>e in r?Ci(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,ct=(r,e,t)=>(Ni(r,typeof e!="symbol"?e+"":e,t),t),Wt=(r=>(r.ChatGPT="chatgpt",r.GPT3="gpt3",r))(Wt||{});function Ii(r="",e){const t=r?r.replace(/&#39;/g,"'").replace(/(\r\n)+/g,`\r
`).replace(/(\s{2,})/g," ").replace(/^(\s)+|(\s)$/g,""):"";return ki(t,e)}const Vt=14e3,$i=800,Pi=1300;function ki(r,e){let t=r;const n=Ui(r).length;if(n>Vt){const s=Vt/n;t=r.substring(0,Math.floor(r.length*s))}return ji(t,e)}function ji(r,e){const t=e==="gpt3"?Pi:$i;let n=Le(r);if(n>t){let s=r;for(;n>t;){const i=n-t;s=s.substring(0,s.length-(i/2<10?10:i/2)),n=Le(s)}return s}return r}function Ui(r){return decodeURIComponent(encodeURIComponent(escape(r))).replace(/%([0-9A-F]{2})/gi,(e,t)=>{const n=parseInt(t,16);return String.fromCharCode(n)})}class Di{constructor(e){ct(this,"apiKey"),ct(this,"webData"),ct(this,"lang"),this.apiKey=e.apiKey,this.webData=e.webData,this.lang=e.lang}async call(e){if(!e&&!this.webData)throw new Error("SummarizeContent error: No WebInfo Data");const t=e||this.webData;return await Li(this.apiKey,t,this.lang)}}async function Li(r,e,t="zh-CN"){let n="",s=[],i=e.content;if(i=sr(i),Le(i)>40){i=Ii(i,Wt.GPT3);const c={content:i,language:kn[t],webprompts:e.meta.prompts||""},l=ir(Pn,c),a=(await W(`${In}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:{model:"gpt-3.5-turbo",messages:[{role:"system",content:$n},{role:"user",content:l}],max_tokens:800,temperature:.3}})).choices[0].message.content,h=JSON.parse(a);n=h.summary,s=h.categories}else n=i;const o=s&&s.length?s:["Others"];return{summary:n,categories:o}}var Mi=Object.defineProperty,xi=(r,e,t)=>e in r?Mi(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,je=(r,e,t)=>(xi(r,typeof e!="symbol"?e+"":e,t),t);class Hi{constructor(e){je(this,"webInfo"),je(this,"webCard"),je(this,"summarizeContent"),je(this,"dataStorage"),this.webInfo=e.webInfo,this.webCard=e.webCard,this.summarizeContent=e.summarizeContent,this.dataStorage=e.dataStorage}async call(){const e=await this.webInfo.call();let t={summary:e.content,categories:["Others"]};this.summarizeContent&&(t=await this.summarizeContent.call(e));const n=await this.dataStorage.create({...e,...t});return this.webCard&&(this.webCard.localFn?await this.webCard.call({dataStorage:this.dataStorage,webData:e,savedData:n}):this.webCard.call({dataStorage:this.dataStorage,webData:e,savedData:n}).then(s=>console.log(s)).catch(s=>console.error(pt(s)))),n}}async function Bi(r){const e=/(http(s)?:\/\/)?[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+(:[0-9]{1,5})?[-a-zA-Z0-9()@:%_\\\+\.~#?&//=]*/g,t=r.match(e);if(t){let n=0,s=0,i=0;for(;n<t.length;){const o=u.NOTION_API_KEY,c=u.NOTION_DATABASE_ID,l=u.API_KEY,a=u.STAR_NEXUS_HUB_API,h=t[n],f=new Ri({urls:{webUrl:h},starNexusHub:a}),p=new Ei({url:u.SUPABASE_URL||"",anonKey:u.SUPABASE_ANON_KEY||"",bucket:u.SUPABASE_STORAGE_BUCKET||"",upsert:!0}),g=new Si({starNexusHub:a,imgStorage:p}),m=new Di({apiKey:l}),b=new Mn({apiKey:o,databaseId:c,defaultOgImage:"https://kiafhufrshqyrvlpsdqg.supabase.co/storage/v1/object/public/pics-bed/star-nexus.png?v=starnexusogimage"}),C=await new Hi({webInfo:f,webCard:g,summarizeContent:m,dataStorage:b}).call().then(k=>!0).catch(k=>!1);n++,C?s++:i++}return`Success: ${s}${i?` Fail: ${i}`:""}`}else throw new Error("No Website Matched")}async function Fi(r,e){try{await e.initContext(r)}catch(t){return new Response(se(t),{status:200})}return null}async function Gi(r,e){if(u.DEBUG_MODE){const t=`last_message:${e.SHARE_CONTEXT.chatHistoryKey}`;await $.put(t,JSON.stringify(r),{expirationTtl:3600})}return null}async function Ki(r,e){return u.API_KEY?$?null:T(e)("DATABASE Not Set"):T(e)("OpenAI API Key Not Set")}async function lt(r,e){return u.I_AM_A_GENEROUS_PERSON?null:e.SHARE_CONTEXT.chatType==="private"?u.CHAT_WHITE_LIST.includes(`${e.CURRENT_CHAT_CONTEXT.chat_id}`)?null:T(e)(u.I18N.message.user_has_no_permission_to_use_the_bot(e.CURRENT_CHAT_CONTEXT.chat_id)):M.GROUP_TYPES.includes(e.SHARE_CONTEXT.chatType)?u.GROUP_CHAT_BOT_ENABLE?u.CHAT_GROUP_WHITE_LIST.includes(`${e.CURRENT_CHAT_CONTEXT.chat_id}`)?null:T(e)(u.I18N.message.group_has_no_permission_to_use_the_bot(e.CURRENT_CHAT_CONTEXT.chat_id)):new Response("Not support",{status:401}):T(e)(u.I18N.message.not_supported_chat_type(e.SHARE_CONTEXT.chatType))}async function Ji(r,e){return r.text?null:T(e)(u.I18N.message.not_supported_chat_type_message)}async function qt(r,e){if(!r.text)return new Response("Non text message",{status:200});const t=e.SHARE_CONTEXT.currentBotName;if(t){let n=!1;if(r.reply_to_message&&r.reply_to_message.from.username===t&&(n=!0),r.entities){let s="",i=0;r.entities.forEach(o=>{switch(o.type){case"bot_command":if(!n){const c=r.text.substring(o.offset,o.offset+o.length);c.endsWith(t)&&(n=!0);const l=c.replaceAll(`@${t}`,"").replaceAll(t,"").trim();s+=l,i=o.offset+o.length}break;case"mention":case"text_mention":if(!n){const c=r.text.substring(o.offset,o.offset+o.length);(c===t||c===`@${t}`)&&(n=!0)}s+=r.text.substring(i,o.offset),i=o.offset+o.length;break}}),s+=r.text.substring(i,r.text.length),r.text=s.trim()}return n?null:new Response("No mentioned",{status:200})}return new Response("Not set bot name",{status:200})}async function ht(r,e){return await Lr(r,e)}async function ut(r,e){if(!r.text.startsWith("~"))return null;r.text=r.text.slice(1);const t=r.text.indexOf(" ");if(t===-1)return null;const n=r.text.slice(0,t),s=r.text.slice(t+1).trim();if(e.USER_DEFINE.ROLE.hasOwnProperty(n)){e.SHARE_CONTEXT.role=n,r.text=s;const i=e.USER_DEFINE.ROLE[n];for(const o in i)e.USER_CONFIG.hasOwnProperty(o)&&typeof e.USER_CONFIG[o]==typeof i[o]&&(e.USER_CONFIG[o]=i[o])}}async function Xi(r,e){try{setTimeout(()=>Me(e)("typing").catch(console.error),0);const t=await Bi(r.text);return T(e)(`Saved to StarNexus 🎉.
${t}`)}catch(t){const n=pt(t);return T(e)(`Error: ${n}`)}}async function zi(r,e){const t={private:[lt,Ji,ht,ut],group:[qt,lt,ht,ut],supergroup:[qt,lt,ht,ut]};if(!t.hasOwnProperty(e.SHARE_CONTEXT.chatType))return T(e)(u.I18N.message.not_supported_chat_type(e.SHARE_CONTEXT.chatType));const n=t[e.SHARE_CONTEXT.chatType];for(const s of n)try{const i=await s(r,e);if(i&&i instanceof Response)return i}catch(i){return console.error(i),T(e)(u.I18N.message.handle_chat_type_message_error(e.SHARE_CONTEXT.chatType))}return null}async function Yi(r,e){const t=await r.json();if(u.DEV_MODE&&setTimeout(()=>{$.put(`log:${new Date().toISOString()}`,JSON.stringify(t),{expirationTtl:600}).catch(console.error)}),t.edited_message)throw new Error("Ignore edited message");if(t.message)return t.message;throw new Error("Invalid message")}async function Wi(r){const e=new lr;e.initTelegramContext(r);const t=await Yi(r),n=[Fi,Gi,Ki,zi,Xi];for(const s of n)try{const i=await s(t,e);if(i&&i instanceof Response)return i}catch(i){return console.error(i),new Response(se(i),{status:500})}return null}const Qt="https://github.com/TBXark/ChatGPT-Telegram-Workers/blob/master/doc/DEPLOY.md",Zt="https://github.com/TBXark/ChatGPT-Telegram-Workers/issues",Vi="./init",dt=`
<br/>
<p>For more information, please visit <a href="${Qt}">${Qt}</a></p>
<p>If you have any questions, please visit <a href="${Zt}">${Zt}</a></p>
`;function er(r){return`<p style="color: red">Please set the <strong>${r}</strong> environment variable in Cloudflare Workers.</p> `}async function qi(r){const e=[],t=new URL(r.url).host,n=De?"safehook":"webhook";for(const i of u.TELEGRAM_AVAILABLE_TOKENS){const o=`https://${t}/telegram/${i.trim()}/${n}`,c=i.split(":")[0];e[c]={webhook:await pr(i,o).catch(l=>se(l)),command:await Mr(i).catch(l=>se(l))}}const s=pe(`
    <h1>ChatGPT-Telegram-Workers</h1>
    <h2>${t}</h2>
    ${u.TELEGRAM_AVAILABLE_TOKENS.length===0?er("TELEGRAM_AVAILABLE_TOKENS"):""}
    ${Object.keys(e).map(i=>`
        <br/>
        <h4>Bot ID: ${i}</h4>
        <p style="color: ${e[i].webhook.ok?"green":"red"}">Webhook: ${JSON.stringify(e[i].webhook)}</p>
        <p style="color: ${e[i].command.ok?"green":"red"}">Command: ${JSON.stringify(e[i].command)}</p>
        `).join("")}
      ${dt}
    `);return new Response(s,{status:200,headers:{"Content-Type":"text/html"}})}async function Qi(r){const e=await br(),{pathname:t}=new URL(r.url),n=t.match(/^\/telegram\/(.+)\/history/)[1];if(new URL(r.url).searchParams.get("password")!==e)return new Response("Password Error",{status:401});const o=JSON.parse(await $.get(n)),c=pe(`
        <div id="history" style="width: 100%; height: 100%; overflow: auto; padding: 10px;">
            ${o.map(l=>`
                <div style="margin-bottom: 10px;">
                    <hp style="font-size: 16px; color: #999; margin-bottom: 5px;">${l.role}:</hp>
                    <p style="font-size: 12px; color: #333;">${l.content}</p>
                </div>
            `).join("")}
        </div>
  `);return new Response(c,{status:200,headers:{"Content-Type":"text/html"}})}async function Zi(r){try{return vt(await Wi(r))}catch(e){return console.error(e),new Response(se(e),{status:200})}}async function eo(r){try{const e=new URL(r.url);return e.pathname=e.pathname.replace("/safehook","/webhook"),r=new Request(e,r),vt(De.fetch(r))}catch(e){return console.error(e),new Response(se(e),{status:200})}}async function to(){const r=pe(`
    <h1>ChatGPT-Telegram-Workers</h1>
    <br/>
    <p>Deployed Successfully!</p>
    <p> Version (ts:${u.BUILD_TIMESTAMP},sha:${u.BUILD_VERSION})</p>
    <br/>
    <p>You must <strong><a href="${Vi}"> >>>>> click here <<<<< </a></strong> to bind the webhook.</p>
    <br/>
    ${u.API_KEY?"":er("API_KEY")}
    <p>After binding the webhook, you can use the following commands to control the bot:</p>
    ${xr().map(e=>`<p><strong>${e.command}</strong> - ${e.description}</p>`).join("")}
    <br/>
    <p>You can get bot information by visiting the following URL:</p>
    <p><strong>/telegram/:token/bot</strong> - Get bot information</p>
    ${dt}
  `);return new Response(r,{status:200,headers:{"Content-Type":"text/html"}})}async function ro(r){const e=new URL(r.url).searchParams.get("text")||"Hello World",t=await gt(),n=pe(`
    <h1>ChatGPT-Telegram-Workers</h1>
    <br/>
    <p>Token Counter:</p>
    <p>source text: ${e}</p>
    <p>token count: ${t(e)}</p>
    <br/>
    `);return new Response(n,{status:200,headers:{"Content-Type":"text/html"}})}async function no(){const r=[];for(const t of u.TELEGRAM_AVAILABLE_TOKENS){const n=t.split(":")[0];r[n]=await yr(t)}const e=pe(`
    <h1>ChatGPT-Telegram-Workers</h1>
    <br/>
    <h4>Environment About Bot</h4>
    <p><strong>GROUP_CHAT_BOT_ENABLE:</strong> ${u.GROUP_CHAT_BOT_ENABLE}</p>
    <p><strong>GROUP_CHAT_BOT_SHARE_MODE:</strong> ${u.GROUP_CHAT_BOT_SHARE_MODE}</p>
    <p><strong>TELEGRAM_BOT_NAME:</strong> ${u.TELEGRAM_BOT_NAME.join(",")}</p>
    ${Object.keys(r).map(t=>`
            <br/>
            <h4>Bot ID: ${t}</h4>
            <p style="color: ${r[t].ok?"green":"red"}">${JSON.stringify(r[t])}</p>
            `).join("")}
    ${dt}
  `);return new Response(e,{status:200,headers:{"Content-Type":"text/html"}})}async function so(r){const{pathname:e}=new URL(r.url);if(e==="/")return to();if(e.startsWith("/init"))return qi(r);if(e.startsWith("/telegram")&&e.endsWith("/webhook"))return Zi(r);if(e.startsWith("/telegram")&&e.endsWith("/safehook"))return eo(r);if(u.DEV_MODE||u.DEBUG_MODE){if(e.startsWith("/telegram")&&e.endsWith("/history"))return Qi(r);if(e.startsWith("/gpt3/tokens/test"))return ro(r);if(e.startsWith("/telegram")&&e.endsWith("/bot"))return no()}return null}const io={env:{system_init_message:"你是一个得力的助手"},utils:{not_supported_configuration:"不支持的配置项或数据类型错误"},message:{not_supported_chat_type:r=>`暂不支持${r}类型的聊天`,not_supported_chat_type_message:"暂不支持非文本格式消息",handle_chat_type_message_error:r=>`处理${r}类型的聊天消息出错`,user_has_no_permission_to_use_the_bot:r=>`你没有权限使用这个bot, 请请联系管理员添加你的ID(${r})到白名单`,group_has_no_permission_to_use_the_bot:r=>`该群未开启聊天权限, 请请联系管理员添加群ID(${r})到白名单`},command:{help:{summary:`当前支持以下命令:
`,help:"获取命令帮助",new:"发起新的对话",start:"获取你的ID, 并发起新的对话",img:"生成一张图片, 命令完整格式为 `/img 图片描述`, 例如`/img 月光下的沙滩`",version:"获取当前版本号, 判断是否需要更新",setenv:"设置用户配置，命令完整格式为 /setenv KEY=VALUE",delenv:"删除用户配置，命令完整格式为 /delenv KEY",usage:"获取当前机器人的用量统计",system:"查看当前一些系统信息",role:"设置预设的身份",redo:"重做上一次的对话, /redo 加修改过的内容 或者 直接 /redo",echo:"回显消息"},role:{not_defined_any_role:"还未定义任何角色",current_defined_role:r=>`当前已定义的角色如下(${r}):
`,help:"格式错误: 命令完整格式为 `/role 操作`\n当前支持以下`操作`:\n `/role show` 显示当前定义的角色.\n `/role 角色名 del` 删除指定名称的角色.\n `/role 角色名 KEY=VALUE` 设置指定角色的配置.\n  目前以下设置项:\n   `SYSTEM_INIT_MESSAGE`:初始化消息\n   `OPENAI_API_EXTRA_PARAMS`:OpenAI API 额外参数，必须为JSON",delete_role_success:"删除角色成功",delete_role_error:r=>`删除角色错误: \`${r.message}\``,update_role_success:"更新配置成功",update_role_error:r=>`配置项格式错误: \`${r.message}\``},img:{help:"请输入图片描述。命令完整格式为 `/img 狸花猫`"},new:{new_chat_start:"新的对话已经开始",new_chat_start_private:r=>`新的对话已经开始，你的ID(${r})`,new_chat_start_group:r=>`新的对话已经开始，群组ID(${r})`},setenv:{help:"配置项格式错误: 命令完整格式为 /setenv KEY=VALUE",update_config_success:"更新配置成功",update_config_error:r=>`配置项格式错误: ${r.message}`},version:{new_version_found:(r,e)=>`发现新版本，当前版本: ${JSON.stringify(r)}，最新版本: ${JSON.stringify(e)}`,current_is_latest_version:r=>`当前已经是最新版本, 当前版本: ${JSON.stringify(r)}`},usage:{usage_not_open:"当前机器人未开启用量统计",current_usage:`📊 当前机器人用量

Tokens:
`,total_usage:r=>`- 总用量：${r||0} tokens
- 各聊天用量：`,no_usage:"- 暂无用量"},permission:{not_authorized:"身份权限验证失败",not_enough_permission:(r,e)=>`权限不足,需要${r.join(",")},当前:${e}`,role_error:r=>`身份验证出错:${r.message}`,command_error:r=>`命令执行错误: ${r.message}`}}},oo={env:{system_init_message:"你是一個得力的助手"},utils:{not_supported_configuration:"不支持的配置或數據類型錯誤"},message:{not_supported_chat_type:r=>`當前不支持${r}類型的聊天`,not_supported_chat_type_message:"當前不支持非文本格式消息",handle_chat_type_message_error:r=>`處理${r}類型的聊天消息出錯`,user_has_no_permission_to_use_the_bot:r=>`您沒有權限使用本機器人，請聯繫管理員將您的ID(${r})添加到白名單中`,group_has_no_permission_to_use_the_bot:r=>`該群組未開啟聊天權限，請聯繫管理員將該群組ID(${r})添加到白名單中`},command:{help:{summary:`當前支持的命令如下：
`,help:"獲取命令幫助",new:"開始一個新對話",start:"獲取您的ID並開始一個新對話",img:"生成圖片，完整命令格式為`/img 圖片描述`，例如`/img 海灘月光`",version:"獲取當前版本號確認是否需要更新",setenv:"設置用戶配置，完整命令格式為/setenv KEY=VALUE",delenv:"刪除用戶配置，完整命令格式為/delenv KEY",usage:"獲取機器人當前的使用情況統計",system:"查看一些系統信息",role:"設置預設身份",redo:"重做上一次的對話 /redo 加修改過的內容 或者 直接 /redo",echo:"回显消息"},role:{not_defined_any_role:"尚未定義任何角色",current_defined_role:r=>`當前已定義的角色如下(${r})：
`,help:"格式錯誤：完整命令格式為`/role 操作`\n當前支持的`操作`如下：\n `/role show` 查看當前已定義的角色。\n `/role 角色名 del` 刪除指定的角色。\n `/role 角色名 KEY=VALUE` 設置指定角色的配置。\n  當前支持的設置如下：\n   `SYSTEM_INIT_MESSAGE`：初始化消息\n   `OPENAI_API_EXTRA_PARAMS`：OpenAI API額外參數，必須為JSON",delete_role_success:"刪除角色成功",delete_role_error:r=>`刪除角色出錯：\`${r.message}\``,update_role_success:"更新配置成功",update_role_error:r=>`配置項格式錯誤：\`${r.message}\``},img:{help:"請輸入圖片描述。完整命令格式為`/img raccoon cat`"},new:{new_chat_start:"開始一個新對話",new_chat_start_private:r=>`開始一個新對話，您的ID(${r})`,new_chat_start_group:r=>`開始一個新對話，群組ID(${r})`},setenv:{help:"配置項格式錯誤：完整命令格式為/setenv KEY=VALUE",update_config_success:"更新配置成功",update_config_error:r=>`配置項格式錯誤：\`${r.message}\``},version:{new_version_found:(r,e)=>`發現新版本，當前版本：${JSON.stringify(r)}，最新版本：${JSON.stringify(e)}`,current_is_latest_version:r=>`當前已是最新版本，當前版本：${JSON.stringify(r)}`},usage:{usage_not_open:"當前機器人未開啟使用情況統計",current_usage:`📊 當前機器人使用情況

使用情況：
`,total_usage:r=>`- 總計：${r||0} 次
- 每個群組使用情況： `,no_usage:"- 暫無使用情況"},permission:{not_authorized:"身份權限驗證失敗",not_enough_permission:(r,e)=>`權限不足，需要${r.join(",")}，當前：${e}`,role_error:r=>`身份驗證出錯：${r.message}`,command_error:r=>`命令執行出錯：${r.message}`}}},ao={env:{system_init_message:"You are a helpful assistant"},utils:{not_supported_configuration:"Not supported configuration or data type error"},message:{not_supported_chat_type:r=>`Currently not supported ${r} type of chat`,not_supported_chat_type_message:"Currently not supported non-text format messages",handle_chat_type_message_error:r=>`Error handling ${r} type of chat messages`,user_has_no_permission_to_use_the_bot:r=>`You do not have permission to use this bot, please contact the administrator to add your ID (${r}) to the whitelist`,group_has_no_permission_to_use_the_bot:r=>`The group has not enabled chat permissions, please contact the administrator to add the group ID (${r}) to the whitelist`},command:{help:{summary:`The following commands are currently supported:
`,help:"Get command help",new:"Start a new conversation",start:"Get your ID and start a new conversation",img:"Generate an image, the complete command format is `/img image description`, for example `/img beach at moonlight`",version:"Get the current version number to determine whether to update",setenv:"Set user configuration, the complete command format is /setenv KEY=VALUE",delenv:"Delete user configuration, the complete command format is /delenv KEY",usage:"Get the current usage statistics of the robot",system:"View some system information",role:"Set the preset identity",redo:"Redo the last conversation, /redo with modified content or directly /redo",echo:"Echo the message"},role:{not_defined_any_role:"No roles have been defined yet",current_defined_role:r=>`The following roles are currently defined (${r}):
`,help:"Format error: the complete command format is `/role operation`\nThe following `operation` is currently supported:\n `/role show` Display the currently defined roles.\n `/role role name del` Delete the specified role.\n `/role role name KEY=VALUE` Set the configuration of the specified role.\n  The following settings are currently supported:\n   `SYSTEM_INIT_MESSAGE`: Initialization message\n   `OPENAI_API_EXTRA_PARAMS`: OpenAI API extra parameters, must be JSON",delete_role_success:"Delete role successfully",delete_role_error:r=>`Delete role error: \`${r.message}\``,update_role_success:"Update configuration successfully",update_role_error:r=>`Configuration item format error: \`${r.message}\``},img:{help:"Please enter the image description. The complete command format is `/img raccoon cat`"},new:{new_chat_start:"A new conversation has started",new_chat_start_private:r=>`A new conversation has started, your ID (${r})`,new_chat_start_group:r=>`A new conversation has started, group ID (${r})`},setenv:{help:"Configuration item format error: the complete command format is /setenv KEY=VALUE",update_config_success:"Update configuration successfully",update_config_error:r=>`Configuration item format error: ${r.message}`},version:{new_version_found:(r,e)=>`New version found, current version: ${JSON.stringify(r)}, latest version: ${JSON.stringify(e)}`,current_is_latest_version:r=>`Current is the latest version, current version: ${JSON.stringify(r)}`},usage:{usage_not_open:"The current robot is not open for usage statistics",current_usage:`📊 Current robot usage

Tokens:
`,total_usage:r=>`- Total: ${r||0} tokens
- Per chat usage: `,no_usage:"- No usage"},permission:{not_authorized:"Identity permission verification failed",not_enough_permission:(r,e)=>`Insufficient permissions, need ${r.join(",")}, current: ${e}`,role_error:r=>`Identity verification error: ${r.message}`,command_error:r=>`Command execution error: ${r.message}`}}};function co(r){switch(r.toLowerCase()){case"cn":case"zh-cn":case"zh-hans":return io;case"zh-tw":case"zh-hk":case"zh-mo":case"zh-hant":return oo;case"en":case"en-us":return ao}}return{async fetch(r,e){try{return rr(e,co),await so(r)||new Response("NOTFOUND",{status:404})}catch(t){return console.error(t),new Response(se(t),{status:500})}}}});
